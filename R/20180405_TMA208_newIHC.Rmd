---
title: "IMC vs IHC comparison"
author: "Jana Fischer and Hartland Jackson"
html_document: default
---

#IHC-IMC comprison from Extended Data 2: first part whole image quant, second part single-cell quant

```{r}
library(data.table)
library(RColorBrewer)
library(dplyr)
library(gplots)
library(ggplot2)
library(stringr)
library(ComplexHeatmap)
library(circlize)
library(ggpmisc)
```

```{r Settings}
#Set directory containing all data for IHC IMC comparison
filepath <- c("/home/ubuntu/tmp/server_homes/janaf/Data/2019/Data_publication/IHC_IMC/")

```

#Load IHC QuPATH scoring (image quant)
```{r}
#QuPATH output csv files all contain IHC location

#Load IHC data
EcadherinTissue <- fread(paste(filepath,"QuPATH/ZT208_37_Ecadherin_Annotations.txt",sep=""),header = T)
HER2Tissue <- fread(paste(filepath,"QuPATH/ZT208_39_HER2_Annotations.txt",sep=""),header = T)
ERTissue <- fread(paste(filepath,"QuPATH/ZT208_7_ER_Annotations.txt",sep=""),header = T)
PRTissue <- fread(paste(filepath,"QuPATH/ZT208_8_PR_Annotations.txt",sep=""),header = T)
KI67Tissue <- fread(paste(filepath,"QuPATH/ZT208_6_KI67_Annotations.txt",sep=""),header = T)

#Format IHC quant data
names(EcadherinTissue)[1] <-paste("IHC_location")
names(EcadherinTissue)[6] <-paste("meanDAB_Ecadherin")
names(EcadherinTissue)[11] <-paste("Area")
EcadherinTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',EcadherinTissue$IHC_location)
IHC <- subset(EcadherinTissue, , c('IHC_location','meanDAB_Ecadherin'))

names(HER2Tissue)[1] <-paste("IHC_location")
names(HER2Tissue)[6] <-paste("meanDAB_HER2")
names(HER2Tissue)[11] <-paste("Area")
HER2Tissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',HER2Tissue$IHC_location)
HER2Tissue <- subset(HER2Tissue, , c('IHC_location','meanDAB_HER2'))
IHC = merge(IHC, HER2Tissue, by='IHC_location', all.x = TRUE)

names(ERTissue)[1] <-paste("IHC_location")
names(ERTissue)[6] <-paste("meanDAB_ER")
names(ERTissue)[11] <-paste("Area")
ERTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',ERTissue$IHC_location)
ERTissue <- subset(ERTissue, , c('IHC_location','meanDAB_ER'))
IHC = merge(IHC, ERTissue, by='IHC_location', all.x = TRUE)

names(PRTissue)[1] <-paste("IHC_location")
names(PRTissue)[6] <-paste("meanDAB_PR")
names(PRTissue)[11] <-paste("Area")
PRTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',PRTissue$IHC_location)
PRTissue <- subset(PRTissue, , c('IHC_location','meanDAB_PR'))
IHC = merge(IHC, PRTissue, by='IHC_location', all.x = TRUE)

names(KI67Tissue)[1] <-paste("IHC_location")
names(KI67Tissue)[6] <-paste("meanDAB_KI67")
names(KI67Tissue)[11] <-paste("Area")
KI67Tissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',KI67Tissue$IHC_location)
KI67Tissue <- subset(KI67Tissue, , c('IHC_location','meanDAB_KI67'))
IHC = merge(IHC, KI67Tissue, by='IHC_location', all.x = TRUE)

```

#Load IMC image quant data
```{r}
#Channels to compare between IHC and IMC
IHCvsIMC_channels = c('Intensity_MeanIntensity_ER', 'Intensity_MeanIntensity_PR', 'Intensity_MeanIntensity_HER2', 'Intensity_MeanIntensity_Ecadherin', 'Intensity_MeanIntensity_Ki67')

#Load IMC single channel quantification
IMCtotalimage <- fread(paste(filepath,"IMCQuant_Image.csv",sep=""),header = T)

#Extract core locations
IMCtotalimage[, IMC_location := bbRtools::getInfoFromFileList(as.character(.BY),sep = '_',strPos =7),by=PathName_HER2]
IMC <- subset(IMCtotalimage, , c(IHCvsIMC_channels, 'IMC_location'), by=IMC_location)

```

#Match IHC to IMC cores
```{r}
#Load punch metadata
punch_meta <- fread(paste0(filepath,"punch_meta.csv"),header = T)

#Without metadata
IHCvsIMC_map <- subset(punch_meta, , c('IHC_location', 'IMC_location'))
IHCvsIMC_map = distinct(IHCvsIMC_map)
IHC_mapped = merge(IHCvsIMC_map, IHC, by='IHC_location')
IMC_mapped = merge(IHCvsIMC_map, IMC, by='IMC_location')
IHCvsIMC_mapped = merge(IHC_mapped, IMC, by='IMC_location')

#Add metadata
plot_dat <- merge(IHCvsIMC_mapped, punch_meta, by='IMC_location')
plot_dat <- plot_dat [!duplicated(IMC_location)]

```

#Plot mean Image intensity of IHC vs IMC for individual channels
```{r}
cur_channelname_x = 'meanDAB_PR'
cur_channelname_y = 'Intensity_MeanIntensity_PR'
my.formula <- y ~ x

ggplot(plot_dat, aes_string(x=cur_channelname_x, y=cur_channelname_y ))+
  geom_point(aes(alpha=1, color=as.factor(GRADE),size=1))+
  geom_smooth(method = "lm")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +theme_bw()
```

#All channels
```{r}
#Reformat to have multiple plots based on antibody
IHC_names <- data.frame("Method" = "IHC", "Stain" = colnames(IHC))
IMC_names <- data.frame("Method" = "IMC", "Stain" = colnames(IMC))
IMC_names <- slice(IMC_names,c(6,4,3,1,2,5))
Antigen  <- c("Antigen", "Ecadherin", "HER2", "ER", "PR", "KI67")

IHC_names <- cbind(IHC_names, Antigen)
IHC_names <- IHC_names[-c(1),]
IMC_names <- cbind(IMC_names, Antigen)
IMC_names <- IMC_names[-c(1),]

#IHC_names_long <- melt(IHC_names, id = c("Antigen","Method","Stain"))
#IMC_names_long <- melt(IHC_names, id = c("Antigen","Method", "Stain"))
IHCvsIMC_Antigens <- rbind(IHC_names, IMC_names)

IHCvsIMC_long <- melt(IHCvsIMC_mapped, id = c("IMC_location", "IHC_location"))
names(IHCvsIMC_long)[names(IHCvsIMC_long) == 'variable'] = "Stain"
IHCvsIMC_Antigens_long <- merge(IHCvsIMC_long, IHCvsIMC_Antigens, by = "Stain")

IHCvsIMC_Antigens_wide <- dcast.data.table(IHCvsIMC_Antigens_long, IMC_location+IHC_location+Antigen ~ Method, value.var = "value", fill = NA, fun.aggregate = mean)

#Add meta data
plot_dat <- merge(IHCvsIMC_Antigens_wide, punch_meta, by='IMC_location', suffixes = "")
plot_dat <- plot_dat[GRADE != "",]

#Plot
my.formula <- y ~ x
ggplot(plot_dat, aes_string(x="IHC", y="IMC" ))+
  facet_wrap(facets = "Antigen", scales = "free")+
  geom_point(aes(alpha=1, color=as.factor(GRADE),size=1))+
  geom_smooth(method = "lm")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +theme_bw()
```

#Read in Single-cell IHC data for comparison with IMC quant
```{r}
#Read in positive count metadata from clinical assessment
Sample_metadat_zuri = fread('/home/ubuntu/tmp/server_homes/janaf/Data/2019/Data_publication/IHC_IMC/Meta_IHCcounts.csv',header = T)

#Read in SC quant IHC data from QuPath
Ki67pos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ki-67_Pos.txt",sep=""),header = T)
Ki67pos[,marker := 'Ki67pos']
Ki67pos[,all := 'Ki67']
Ki67pos = Ki67pos[,c('Name','marker','all')]

Ki67neg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ki-67_Neg.txt",sep=""),header = T)
Ki67neg[,marker := 'Ki67neg']
Ki67neg[,all := 'Ki67']
Ki67neg = Ki67neg[,c('Name','marker','all')]

PRpos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_PR_Pos.txt",sep=""),header = T)
PRpos[,marker := 'PRpos']
PRpos[,all := 'PR']
PRpos = PRpos[,c('Name','marker','all')]

PRneg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_PR_Neg.txt",sep=""),header = T)
PRneg[,marker := 'PRneg']
PRneg[,all := 'PR']
PRneg = PRneg[,c('Name','marker','all')]

ERpos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Pos.txt",sep=""),header = T)
ERpos[,marker := 'ERpos']
ERpos[,all := 'ER']
ERpos = ERpos[,c('Name','marker','all')]

ERneg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Neg.txt",sep=""),header = T)
ERneg[,marker := 'ERneg']
ERneg[,all := 'ER']
ERneg = ERneg[,c('Name','marker','all')]

#Format into one table and calculate measures
IHCSC = rbind(Ki67pos,Ki67neg,PRpos,PRneg,ERpos,ERneg)
IHCSC[,'Name']<- gsub(' - PathCellObject', '',IHCSC$Name)
IHCSC[,IHC_count := .N ,by = c('Name','marker')]
IHCSC[,tot_cells := .N, by = c('Name','all')]
IHCSC[,frac := IHC_count/tot_cells]
IHCSC = unique(IHCSC)

#Kick out controls
IHCSC= IHCSC[!Name %in% unique(IHCSC$Name[!IHCSC$Name %in% IHCvsIMC_map$IHC_location]),]
IHCvsIMC_map= IHCvsIMC_map[!IHC_location %in% unique(IHCvsIMC_map$IHC_location[!IHCvsIMC_map$IHC_location %in% IHCSC$Name]),]

#Map names of IMC and IHC cores
IHCSC$IMCname = mapvalues(IHCSC$Name, unique(IHCSC$Name), IHCvsIMC_map[match(unique(IHCSC$Name),IHCvsIMC_map$IHC_location),IMC_location], warn_missing = TRUE)
```

#IHC and IMC positive single-cell quantitfication comparison
```{r}
#Take single-cell IMC data and dcast
wide = dcast.data.table(dat,formula = 'core + id ~ channel', value.var = 'c_counts')

#Look at distributions of markers of interest to decide on positive cell threshold
ggplot(wide, aes(x=`1441101Er168Di Ki67`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")

ggplot(wide, aes(x=`1441101Er168Di Ki67`))+
  geom_density()+
  xlim(c(0,2))

#Count positive cells per core for Ki67 acoording to set threshold
wide[,IMC_pos_count := length(which(`1441101Er168Di Ki67` > 0.5 )),by = 'core'] #/.N   for fraction
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

#Merge with IHC data
comb = merge(sub,unique(IHCSC[marker == 'Ki67pos',]), by = 'IMCname')
comb = merge(comb, Sample_metadata, by = 'core')

#Plot correlation of amount of positively counted single cells for IMC and IHC
my.formula <- y ~ x
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) + theme_bw()


#ER
ggplot(wide, aes(x=`112475Gd156Di Estroge`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
ggplot(wide, aes(x=`112475Gd156Di Estroge`))+
  geom_density()+
  xlim(c(0,2))

#Count positive cells per core for ER acoording to set threshold
wide[,IMC_pos_count := length(which(`112475Gd156Di Estroge` > 1 )),by = 'core'] #/.N   for fraction
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

#Merge with IHC data
comb = merge(sub,unique(IHCSC[marker == 'ERpos',]), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','PID')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('PID','Erperc')]), by = 'PID',all.x = T)
my.formula <- y ~ x
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=Erperc, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()



#PR
ggplot(wide, aes(x=`312878Gd158Di Progest`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")

wide[,IMC_pos_count := length(which(`312878Gd158Di Progest` > 1 )),by = 'core'] 
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

comb = merge(sub,unique(IHCSC[marker == 'PRpos',]), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','PID')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('PID','Prperc')]), by = 'PID',all.x = T)

my.formula <- y ~ x

ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1, color=Prperc, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()


#E-Cadherin
Ecadh <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ecadherin.txt",sep=""),header = T)
Ecadh[,marker := 'Ecadh']
Ecadh = Ecadh[,c('Name','marker','Cell: DAB OD mean')]

ggplot(Ecadh, aes(x=`Cell: DAB OD mean`)) + 
    geom_density(alpha=.2, fill="#FF6666")

#Set threshold for positive IHC cells
Ecadh[,IHC_count := length(which(`Cell: DAB OD mean` > 0.25 )),by = 'Name']
Ecadh[,'Name']<- gsub(' - PathCellObject', '',Ecadh$Name)
Ecadh = unique(Ecadh[,c('Name','IHC_count')])

#Map core names
Ecadh= Ecadh[!Name %in% unique(Ecadh$Name[!Ecadh$Name %in% IHCvsIMC_map$IHC_location]),]
IHCvsIMC_map= IHCvsIMC_map[!IHC_location %in% unique(IHCvsIMC_map$IHC_location[!IHCvsIMC_map$IHC_location %in% Ecadh$Name]),]
Ecadh$IMCname = mapvalues(Ecadh$Name, unique(Ecadh$Name), IHCvsIMC_map[match(unique(Ecadh$Name),IHCvsIMC_map$IHC_location),IMC_location], warn_missing = TRUE)

#Set threshold for positive IMC cells
ggplot(wide, aes(x=`1031747Er167Di ECadhe`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
ggplot(wide, aes(x=`1031747Er167Di ECadhe`))+
  geom_density()

wide[,IMC_pos_count := length(which(`1031747Er167Di ECadhe` > 3 )),by = 'core']
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

comb = merge(sub,unique(Ecadh), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','PID')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('PID','Ecadh')]), by = 'PID',all.x = T)
my.formula <- y ~ x

ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=Ecadh, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +theme_bw()


#HER2
HER2 <- fread(paste(filepath,"/QuPATH/ZT208_39 Detections.txt",sep=""),header = T)
HER2[,marker := 'HER2']
HER2 = HER2[,c('Name','marker','Cell: DAB OD mean')]

ggplot(HER2, aes(x=`Cell: DAB OD mean`)) + 
    geom_density(alpha=.2, fill="#FF6666")

#Set threshold for positive IHC cells
HER2[,IHC_count := length(which(`Cell: DAB OD mean` > 0.5 )),by = 'Name'] #/.N   for fraction
HER2[,'Name']<- gsub(' - PathCellObject', '',HER2$Name)
HER2 = unique(HER2[,c('Name','IHC_count')])

#Map core names
HER2= HER2[!Name %in% unique(HER2$Name[!HER2$Name %in% IHCvsIMC_map$IHC_location]),]
IHCvsIMC_map= IHCvsIMC_map[!IHC_location %in% unique(IHCvsIMC_map$IHC_location[!IHCvsIMC_map$IHC_location %in% HER2$Name]),]
HER2$IMCname = mapvalues(HER2$Name, unique(HER2$Name), IHCvsIMC_map[match(unique(HER2$Name),IHCvsIMC_map$IHC_location),IMC_location], warn_missing = TRUE)

#Set threshold for positive IMC cells
ggplot(wide, aes(x=`201487Eu151Di cerbB`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
ggplot(wide, aes(x=`201487Eu151Di cerbB`))+
  geom_density()

wide[,IMC_pos_count := length(which(`201487Eu151Di cerbB` > 3 )),by = 'core'] 
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

comb = merge(sub,unique(HER2), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','PID')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('PID','HER2')]), by = 'PID',all.x = T)
my.formula <- y ~ x

ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=HER2, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()

```

