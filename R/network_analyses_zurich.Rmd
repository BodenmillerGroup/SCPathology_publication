---
title: "R Notebook"
output: html_notebook
---



#Read in fragmentation scores
```{r}
frag = fread('/home/jana/Desktop/R_dat/fragmentation_zurich.csv',header = T)


test = unique(frag$core)
split_core = strsplit(frag$core,'_', fixed = TRUE)
frag$core = unlist(lapply(split_core, function(x){paste(x[c(1,2,8,9,10)],collapse =  "_")}))
#Replace the ones that don't need acquisition number again
short = unlist(lapply(strsplit(test,'_', fixed = TRUE),function(x){paste(x[c(1,2,8,9)],collapse =  "_")}))
duplicate_idx = duplicated(short) | duplicated(short, fromLast = TRUE)
in_cores_index = unlist(lapply(unique(frag$core)[duplicate_idx],function(x){which(frag$core %in% x)}))
frag$core[setdiff(1:length(frag$core),in_cores_index)] = unlist(lapply(strsplit(frag$core[setdiff(1:length(frag$core),in_cores_index)],'_', fixed = TRUE), function(x){paste(x[1:length(x)-1],collapse =  "_")}))

#Delete zeros from core names
frag$core = unlist(lapply(frag$core,function(x){gsub("000","",x)}))

# #Merge with metadata
# frag = merge(frag, unique(Sample_metadata[,c('core','patientcode')]),by = 'core')
frag[,frag_log := log(frag)]

frag[,frag_score := ((frag_log - min(frag_log))/(max(frag_log) - min(frag_log)))]

#Set not present images NA
missing = all_order$core[!all_order$core %in% frag$core]
frag = rbind(frag,data.frame(core = missing,frag_score = rep(NA,length(missing)),frag = rep(NA,length(missing)),frag_log = rep(NA,length(missing))))
frag = frag[(core %in% all_order$core),]
frag = unique(frag[,c('core','frag_score')])

#Order according to Basel
frag =  frag[order(match(frag$core,all_order$core))]



#Fragmentation colorbar
p7 <- ggplot(frag, aes(x=1,y=c(1:length(frag$frag_score))))+
      geom_tile(aes( fill=frag$frag_score))+
  scale_fill_gradient2(low = "blue", mid = "white", high = "purple")+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          line = element_blank(),
          legend.position="none")

p6 <- ggdraw() +
     draw_plot(p2 + scale_y_reverse(), 0, 0.005, 0.36, 0.984) +
     draw_plot(p ,0.47, 0.035, 0.5, 0.926)+
   draw_plot(p3,0.45,0,0.05,1)+
  draw_plot(p7,0.39,0,0.05,1)

pdf(file="/home/jana/Desktop/R_dat/fragmentationscore_zurich.pdf", width=30, height=50)
p6
dev.off()


g = ggplot(frag, aes(x = MeanSize))+
  geom_density()

pdf('/home/jana/Desktop/R_dat/kldiv_distribution_networksizethreshold20.pdf')
g
dev.off()
```


#Read in nodules dat
```{r}

nodules = fread('/home/jana/Desktop/R_dat/nodules_tumor_zurich.csv',header = T)

#Exclude weak stains?
nodules = nodules[!str_detect(nodules$core,regex('Ay.x1')),]
nodules = nodules[!str_detect(nodules$core,regex('Ay..x1')),]

nodules = nodules[!str_detect(nodules$core,'control'),]
nodules = nodules[!str_detect(nodules$core,'non-breast'),]

#Threhsold 20
nodules[,size_comm := .N, by = c('Community','core')]
#nodules = nodules[size_comm > 19,] # increase to >19 for sbp of mixed tumors

test = unique(nodules$core)
split_core = strsplit(nodules$core,'_', fixed = TRUE)
nodules$core = unlist(lapply(split_core, function(x){paste(x[c(1,2,8,9,10)],collapse =  "_")}))
#Replace the ones that don't need acquisition number again
short = unlist(lapply(strsplit(test,'_', fixed = TRUE),function(x){paste(x[c(1,2,8,9)],collapse =  "_")}))
duplicate_idx = duplicated(short) | duplicated(short, fromLast = TRUE)
in_cores_index = unlist(lapply(unique(nodules$core)[duplicate_idx],function(x){which(nodules$core %in% x)}))
nodules$core[setdiff(1:length(nodules$core),in_cores_index)] = unlist(lapply(strsplit(nodules$core[setdiff(1:length(nodules$core),in_cores_index)],'_', fixed = TRUE), function(x){paste(x[1:length(x)-1],collapse =  "_")}))

#Delete zeros from core names
nodules$core = unlist(lapply(nodules$core,function(x){gsub("000","",x)}))

tmp = nodules$Pheno
tmp[nodules$Pheno %in% 37] = 26
tmp[nodules$Pheno %in% c(4,10,11,27)] = 22
tmp[nodules$Pheno %in% c(6)] = 24
tmp[nodules$Pheno %in% c(19,22,29)] = 23
tmp[nodules$Pheno %in% c(24,31)] = 25
tmp[nodules$Pheno %in% c(14,30,32)] = 20
tmp[nodules$Pheno %in% c(9,23,33,34,40)] = 19
tmp[nodules$Pheno %in% c(13)] = 27
tmp[nodules$Pheno %in% c(12)] = 18
tmp[nodules$Pheno %in% c(17)] = 17
tmp[nodules$Pheno %in% c(20,38,15)] = 16
tmp[nodules$Pheno %in% c(26,35)] = 15
tmp[nodules$Pheno %in% c(25)] = 14
tmp[nodules$Pheno %in% c(4,10,11,27)] = 22
tmp[nodules$Pheno %in% c(8)] = 21
nodules$Pheno = tmp


nodules[,ncells := .N , by = c('Community','Pheno','core')]
nodules[,perc_cluster := ncells/size_comm, by = c('Community','core')]
save_size = unique(nodules[,c('core','Community','size_comm')])
nodules_orig = nodules


#KL divergence per image

#Image mean
nodules <- unique(nodules[,c("core","Pheno","ncells","Community")]) #use perc_cluster for mixed nodules
nodules$Pheno = factor(nodules$Pheno, levels = sort(unique(nodules$Pheno)))


#Make missing cells types 0
nodules_wide = dcast.data.table(nodules,formula = 'Community + core ~ Pheno',value.var = 'ncells',fill = 0) #user perc_cluster for mixed nodules
nodules_long = melt.data.table(nodules_wide, id.vars = c('Community','core') ,variable.name = 'cluster', value.name = 'perc_cluster')

#split into patients
ind_cores <- split( nodules_long , f = nodules_long$core )
ind_cores = lapply(ind_cores, function(x){x[order(x$Community),]})
all_core_comm = lapply(ind_cores,function(x){x[, core_mean := mean(perc_cluster), by=cluster]})
ind_comm <- lapply(all_core_comm, function(x){split( x , f = x$Community )})

library("entropy")
kldiv <- lapply(ind_comm, function(x){lapply(x,function(y){KL.plugin(y$perc_cluster, na.omit(y$core_mean))})})
sum_kldiv <- lapply(kldiv,function(x){Reduce("+",x)})
length_kldiv <- lapply(kldiv,function(x){length(x)})
mean_kldiv_core <- unlist(t(sum_kldiv))/unlist(t(length_kldiv))

comm_kldiv = data.table(unlist(names(kldiv)))
names(comm_kldiv) = "core"
comm_kldiv$kldiv = mean_kldiv_core


#Set not present images NA
missing = all_order$core[!all_order$core %in% comm_kldiv$core]
comm_kldiv = rbind(comm_kldiv,data.frame(core = missing,kldiv = rep(NA,length(missing))))
comm_kldiv = comm_kldiv[comm_kldiv$core %in% all_order$core,]
comm_kldiv = unique(comm_kldiv[,c('core','kldiv')])

#Order according to Basel
comm_kldiv =  comm_kldiv[order(match(comm_kldiv$core,all_order$core))]


threshold = quantile(comm_kldiv$kldiv, probs = 0.95,na.rm = T)
m = mean(comm_kldiv$kldiv)
std1 = std(comm_kldiv$kldiv)

#Binary
comm_kldiv$bin[comm_kldiv$kldiv < threshold] = 0
comm_kldiv$bin[comm_kldiv$kldiv >= threshold] = 1

#Fragmentation colorbar
p6 <- ggplot(comm_kldiv, aes(x=1,y=c(1:length(comm_kldiv$bin))))+
      geom_tile(aes( fill=comm_kldiv$bin))+
  scale_fill_gradient2(low = "blue", mid = "white", high = "blue")+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          line = element_blank(),
          legend.position="none")

p4 <- ggdraw() +
     draw_plot(p2 + scale_y_reverse(), 0, 0.005, 0.36, 0.984) +
     draw_plot(p ,0.47, 0.035, 0.5, 0.926)+
   draw_plot(p3,0.45,0,0.05,1)+
  draw_plot(p7,0.39,0,0.05,1)+
    draw_plot(p6,0.39,0,0.05,1)

pdf(file="/home/jana/Desktop/R_dat/fragmentationscore_nodulemixing_test.pdf", width=30, height=50)
p4
dev.off()



g = ggplot(comm_kldiv, aes(x = kldiv))+
  geom_density()+
  geom_vline(xintercept = threshold, color = 'red')

pdf('/home/jana/Desktop/R_dat/kldiv_distribution_networksizethreshold20.pdf')
g
dev.off()


```

#Tsne communtities
```{r}

#Add size and normalize
#nodules_wide = merge(nodules_wide,save_size,by = c('core','Community'))
nodules_wide = cbind( nodules_wide[,c('Community','core')],apply(nodules_wide[,-c('Community','core')],2, function(x){(x-min(x))/(max(x)-min(x))}))

rand_seed = 3
rpheno_out = cytofkit::Rphenograph(nodules_wide[,-c('Community','core')], k = 80, seed = rand_seed,approx = T)
nodules_wide$cluster = rpheno_out$membership


#fwrite(nodules_wide[,c('Community','cluster')],'/home/jana/Desktop/R_dat/PG_epi_zuri.csv',col.names = T)

cl_dat = fread('/home/jana/Desktop/R_dat/PG_epi_zuri.csv',header = T) 
nodules_wide$cluster = cl_dat$cluster

require(doParallel)
cores = 10
options('mc.cores' = cores)
registerDoParallel(cores)
dat_tsne = nodules_wide[!duplicated(nodules_wide[,-c('Community','core','cluster')])]
tsne_comm <- Rtsne.multicore::Rtsne.multicore(dat_tsne[,-c('Community','core','cluster')],
            verbose = T, dims = 2, num_threads = 10)


# tsne_comm = tsne(nodules_wide[,-c('Community','core')], initial_config = NULL, k = 2, initial_dims = 30, perplexity = 30,
# max_iter = 1000, min_cost = 0, epoch_callback = NULL, whiten = TRUE,
# epoch=100)

#fwrite(tsne_comm,'/home/jana/Desktop/R_dat/tsne_epi_zuri.csv',col.names = F)

tsne_comm = fread('/home/jana/Desktop/R_dat/tsne_epi_zuri.csv') #tsne_comm.csv

dat_tsne = cbind(dat_tsne,tsne_comm)
dat_tsne = merge(unique(Sample_metadata[,c('core','patientcode')]),dat_tsne,by = 'core')
dat_tsne = merge(dat_tsne,asigned,by = 'core')
dat_tsne$patient_pheno = as.factor(dat_tsne$patient_pheno)

p = dat_tsne%>%
  ggplot(aes(x=V1, y=V2))+
  geom_point(size=1, alpha=0.8, aes(color=patient_pheno))+
  labs(colour="Patients")+
  scale_color_manual(values = mycols_patient[sort(as.numeric(levels(dat_tsne$patient_pheno)))])+
  ggtitle('Phenograph')+
  guides(color=guide_legend(override.aes=list(size=5)))+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

pdf('/home/jana/Desktop/R_dat/tsne_communities_colorPatientgroup.pdf',width = 10,height = 10)
p
dev.off()

dat_tsne$cluster = factor(dat_tsne$cluster,levels = hr$labels[hr$order])
p = dat_tsne%>%
  ggplot(aes(x=V1, y=V2))+
  geom_point(size=1, alpha=0.8, aes(color=cluster))+
  labs(colour="Patients")+
  scale_color_manual(values = col_vector[as.numeric(hr$labels[hr$order])])+
  ggtitle('Phenograph')+
  guides(color=guide_legend(override.aes=list(size=5)))+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

pdf('/home/jana/Desktop/R_dat/tsne_epithelial_communities_colorPG.pdf',width = 10,height = 10)
p
dev.off()


nodules_long = melt.data.table(nodules_wide, id.vars = c('Community','cluster','core') ,variable.name = 'channel', value.name = 'perc_cluster')

set.seed(2)
summary_dat = nodules_long[ ,list(
  mean_val= mean(perc_cluster),
  #std_val = std(perc_cluster),
  cell_cluster=.N),
  by=.(channel,cluster)]


hm_dat = dcast.data.table(data =summary_dat, formula = 'cluster ~ channel',
                          value.var = 'mean_val') #can be exchanged for 'median_val'

#Bars next to heatmap
d = unique(summary_dat[,c('channel','cluster','mean_val')])
p <- ggplot(d, aes(x=factor(cluster,levels = o$Clustergram), y=mean_val, fill=factor(channel))) + #hr$labels[hr$order]
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values =  c(mycols_basel_meta[14:27],'black'))+ 
  labs(fill = "Clusters")+
  coord_flip()+
  xlab("Patient")+
  ylab("Percentage of cluster cells in patient")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=col_vector[as.numeric(o$Clustergram)]))+ #hr$labels[hr$order]
  ggtitle('Patient composition')

pdf('/home/jana/Desktop/R_dat/comm_cluster_compositions.pdf',width = 10,height = 10)
p
dev.off()

# Row names
trownames = hm_dat$cluster

# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

# Set color map
cols = rev(brewer.pal(11,'Spectral'))
cmap = colorRampPalette(cols)

# Hierarchical clustering on rows with Ward's linkage
tdist = as.dist(1-cor(t(hm_dat), method="spearman"))
hr <- hclust(tdist, method="ward.D2")
co_r <- order.optimal(tdist, hr$merge)
hr$merge = co_r$merge
hr$order = co_r$order

# Order rows in heatmap according to clustering
order_heatmap_zscored = row.names(hm_dat)[hr$order]

# Hierarchical clustering on columns with Ward's linkage
tdist = as.dist(1-cor((hm_dat), method="spearman"))
hc <- hclust(tdist, method="ward.D2")
co_c <- order.optimal(tdist, hc$merge)
hc$merge = co_c$merge
hc$order = co_c$order

# Z-score data
p_dat = scale(hm_dat)

# Censor z-score at 2
p_dat[p_dat > 2] =2
p_dat[p_dat < -2] =-2


pdf(file="/home/jana/Desktop/R_dat/tumor_node_heatmap_k80.pdf", width=10, height=10)

heatmap.2(p_dat,
          scale ='none',
          trace = "none",
          col=cmap(75),
          Rowv=as.dendrogram(hr),
          Colv=as.dendrogram(hc),
          density.info ='none',
          cexRow=0.6,
          cexCol=0.6,
          margins=c(4,8),
          xlab = 'Markers',
          ylab ='Cluster',
          main = 'PG_norm_slide',
          colCol = c(mycols_basel_meta[14:27],'black'),
          colRow = col_vector) #mycols_basel for small clusters

dev.off()




#Clustergrams
nodules_wide = merge(unique(Sample_metadata[,c('core','patientcode')]),nodules_wide,by = 'core')
nodules_wide = merge(nodules_wide,asigned,by = 'core')
nodules_wide$patient_pheno = as.factor(nodules_wide$patient_pheno)
enrichment = unique(nodules_wide[,c('cluster','Community','core')])
enrichment[,both := .N, by = c('cluster','core')]
enrichment[,frac_patient := both/.N, by = c('core')]
enrichment = unique(enrichment[,c('core','cluster','frac_patient')])
d = dcast.data.table(enrichment,formula = 'core  ~ cluster',value.var = 'frac_patient',fill = 0)
d_mat = as.matrix(d[,-'core'])
rownames(d_mat) = d$patientcode
d = merge(d, asigned,by = 'core')

h = Heatmap(d_mat, name = "Clustergram", km = 1, col = colorRamp2(c(0, 1), c("white", "red")),
     show_row_names = T, show_column_names =  T, clustering_method_rows = "ward.D2",clustering_method_columns = "ward.D2")+

Heatmap(factor(d$patient_pheno), name = "Patientgroups", show_row_names = FALSE, width = unit(10, "mm"), col = structure(mycols_patient, names = c(as.character(1:18))))

pdf('/home/jana/Desktop/R_dat/levels_epithelial_communities_patientgroup_colors.pdf',width = 10, height = 20)
h
dev.off()


#By patient


missing = all_order$core[!all_order$core %in% d$core]
add =  matrix(data=0,nrow=length(missing),ncol=ncol(d)-1)
add = as.data.table(add)
add$core = missing
colnames(add) = c('1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','core')
d = rbind(d,add)
d = merge(d,Sample_metadata[,c('core','patientcode')],by = 'core')
d = merge(d, asigned,by = 'core')
d = d[order(match(d$core,rev(all_order$core))),]

d_mat = as.matrix(d[,-c('core','patient_pheno','patientcode')])
rownames(d_mat) = d$core
h = Heatmap(d_mat, name = "Clustergram", km = 1, col = colorRamp2(c(0, 1), c("white", "red")),
     show_row_names = T, show_column_names =  T,cluster_rows = FALSE,clustering_method_columns = "ward.D2")+
  Heatmap(factor(d$patient_pheno), name = "SCP", show_row_names = FALSE, width = unit(10, "mm"), col = structure(mycols_patient, names = c(as.character(1:18))))+
  Heatmap(factor(d$patientcode), name = "Patient", show_row_names = FALSE, width = unit(10, "mm"), col = structure(c(col_vector,'black'), names = c(unique(d$patientcode))))

o_epi = column_order(h)

pdf('/home/jana/Desktop/R_dat/levels_ordered_patient.pdf',width = 10, height = 20)
h
dev.off()





```

#Center periphery
```{r}
nodules_wide = merge(unique(Sample_metadata[,c('core','patientcode','location')]),nodules_wide,by = 'core')


cluster_loc = nodules_wide[,c('cluster','core','Community','location')]
cluster_loc = cluster_loc[!location %in% c('NORMAL','METASTASIS','[]'),]
cluster_loc[,count := .N, by = c('cluster','location')]
cluster_loc[,frac_cluster := count/.N, by = 'cluster']
cluster_loc[,frac_location := count/.N, by = 'location']
cluster_loc = unique(cluster_loc[,c('cluster','location','frac_cluster')])



p <- ggplot(cluster_loc, aes(x=factor(cluster,levels = hr$labels[hr$order]), y=frac_cluster, fill=factor(location,levels = c('CENTER','PERIPHERY','NORMAL','METASTASIS')))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values = c('red','blue','grey','black'))+ # rev(mycols)[!cluster_order %in% c(1,3:5,7:8,11,13,22,25:26,33:34)]
  labs(fill = "Location")+
  coord_flip()+
  xlab("loc")+
  ylab("Frac cluster")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=col_vector[as.numeric(hr$labels[hr$order])]))+
  ggtitle('Location composition')


pdf('/home/jana/Desktop/R_dat/zurich_community_location.pdf',width = 10, height = 20)
p
dev.off()

```

#Correlation among epi comm
```{r}

surv = unique(nodules_wide[,c('patientcode','cluster','Community','core')])
surv[,nr_both := .N, by = c('cluster','core')]
surv = merge(surv,unique(Sample_metadata[,c('core','area')]),by = 'core')
surv[,nodule_area := nr_both/area, by = 'core']
surv[,nodule_area_patient := mean(nodule_area),by = c('patientcode','cluster')]
surv = unique(surv[,c('patientcode','cluster','nodule_area_patient')])
surv = dcast.data.table(surv,'patientcode ~ cluster',fill = 0)

o = column_order(h)
surv = surv[,c('patientcode',as.character(o$Clustergram)),with = F]

colnames(surv)[-c(1)] = paste0('cluster_',colnames(surv)[-c(1)])

#Change Unit so the values aren't all super small
surv = cbind(surv[,c(1)],data.table(as.matrix(surv[,-c(1)]) * 100000))


surv_mat = as.matrix(surv[,-'patientcode'])
rownames(surv_mat) = surv$patientcode

incor = cor(surv_mat)

pdf('/home/jana/Desktop/R_dat/corr_epi_zurich.pdf',width = 20,height = 20)
corrplot(cor(surv_mat), method = "color",col=colorRampPalette(c("blue","white","red"))(200))
dev.off()
```

#Read in stroma nodules dat
```{r}
nodules = fread('/home/jana/Desktop/R_dat/nodules_stroma_zurich.csv',header = T)


test = unique(nodules$core)
split_core = strsplit(nodules$core,'_', fixed = TRUE)
nodules$core = unlist(lapply(split_core, function(x){paste(x[c(1,2,8,9,10)],collapse =  "_")}))
#Replace the ones that don't need acquisition number again
short = unlist(lapply(strsplit(test,'_', fixed = TRUE),function(x){paste(x[c(1,2,8,9)],collapse =  "_")}))
duplicate_idx = duplicated(short) | duplicated(short, fromLast = TRUE)
in_cores_index = unlist(lapply(unique(nodules$core)[duplicate_idx],function(x){which(nodules$core %in% x)}))
nodules$core[setdiff(1:length(nodules$core),in_cores_index)] = unlist(lapply(strsplit(nodules$core[setdiff(1:length(nodules$core),in_cores_index)],'_', fixed = TRUE), function(x){paste(x[1:length(x)-1],collapse =  "_")}))

#Delete zeros from core names
nodules$core = unlist(lapply(nodules$core,function(x){gsub("000","",x)}))

nodules[,size_comm := .N, by = c('Community','core')]
#nodules = nodules[size_comm > 19,]
nodules[,ncells := .N , by = c('Community','Pheno','core')]
nodules[,perc_cluster := ncells/size_comm, by = c('core','Community')]
save_size = unique(nodules[,c('core','Community','size_comm')])
nodules_orig = nodules

#Image mean
nodules <- unique(nodules[,c("core","Pheno","ncells","Community")])
nodules$Pheno = factor(nodules$Pheno, levels = c(rev(cluster_order[cluster_order %in% c("41","3","39","7","2" ,"21","28","18","5","1","16")]),"100"))

#Make missing cells types 0
nodules_wide = dcast.data.table(nodules,formula = 'Community + core ~ Pheno',value.var = 'ncells',fill = 0)

#Normalize
nodules_wide = cbind( nodules_wide[,c('Community','core')],apply(nodules_wide[,-c('Community','core')],2, function(x){(x-min(x))/(max(x)-min(x))}))

#PG for identifying different structures
rand_seed = 3
rpheno_out = cytofkit::Rphenograph(nodules_wide[,-c('Community','core')], k = 20, seed = rand_seed,approx = T)
nodules_wide$cluster = rpheno_out$membership


#fwrite(nodules_wide[,c('Community','cluster')],'/home/jana/Desktop/R_dat/PG_stroma_zurich.csv',col.names = T)

cl_dat = fread('/home/jana/Desktop/R_dat/PG_stroma_zurich_k30.csv',header = T)
nodules_wide$cluster = cl_dat$cluster


#tsne
require(doParallel)
cores = 10
options('mc.cores' = cores)
registerDoParallel(cores)
dat_tsne = nodules_wide[!duplicated(nodules_wide[,-c('Community','core','cluster')])] 
tsne_comm <- Rtsne.multicore::Rtsne.multicore(dat_tsne[,-c('Community','core','cluster')], 
            verbose = T, dims = 2, num_threads = 10)


#fwrite(tsne_comm$Y,'/home/jana/Desktop/R_dat/tsne_stroma_zurich.csv',col.names = F)

tsne_comm = fread('/home/jana/Desktop/R_dat/tsne_stroma_zurich.csv')

dat_tsne = cbind(dat_tsne,tsne_comm)

dat_tsne$cluster = factor(dat_tsne$cluster,order_stroma)

p = dat_tsne%>%
  ggplot(aes(x=V1, y=V2))+
  geom_point(size=1, alpha=0.8, aes(color=cluster))+
  labs(colour="Patients")+
  scale_color_manual(values = col_vector[as.numeric(order_stroma)])+
  ggtitle('Phenograph')+
  guides(color=guide_legend(override.aes=list(size=5)))+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

pdf('/home/jana/Desktop/R_dat/stroma_communities_tsne.pdf',width = 10,height = 10)
p
dev.off()

dat_tsne = merge(dat_tsne,Sample_metadata[,c('core','patientcode')],by = 'core')
neighb_clusters = fread('/home/jana/Desktop/Revisions/neighborhood_zurich_clusters.csv',header = T)
dat_tsne = merge(dat_tsne,neighb_clusters, by = 'core')
dat_tsne$cluster.y = factor(dat_tsne$cluster.y )
p = dat_tsne%>%
  ggplot(aes(x=V1, y=V2))+
  geom_point(size=1, alpha=0.8, aes(color=cluster.y ))+
  labs(colour="Patients")+
  scale_color_manual(values = col_vector)+
  ggtitle('Phenograph')+
  guides(color=guide_legend(override.aes=list(size=5)))+
  theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

pdf('/home/jana/Desktop/R_dat/tsne_communities_colorTME.pdf',width = 10,height = 10)
p
dev.off()


#Heatmap to interpret PG clusters
nodules_long = melt.data.table(nodules_wide, id.vars = c('Community','core','cluster') ,variable.name = 'channel', value.name = 'perc_cluster')

set.seed(2)
summary_dat = nodules_long[ ,list(
  mean_val= mean(perc_cluster),
  #std_val = std(perc_cluster),
  cell_cluster=.N),
  by=.(channel,cluster)]


hm_dat = dcast.data.table(data =summary_dat, formula = 'cluster ~ channel',
                          value.var = 'mean_val') #can be exchanged for 'median_val' 

#Bars next to heatmap
d = unique(summary_dat[,c('channel','cluster','mean_val')])
p <- ggplot(d, aes(x=factor(cluster,levels = o_stroma$Clustergram), y=mean_val, fill=factor(channel))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values =  c(rev(rev(mycols)[cluster_order %in% c("41","3" , "39","7","2" ,"21","28","18","5","1","16")]),'black'))+ 
  labs(fill = "Clusters")+
  coord_flip()+
  xlab("Patient")+
  ylab("Percentage of cluster cells in patient")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=col_vector[as.numeric(o_stroma$Clustergram)]))+
  ggtitle('Patient composition')

pdf('/home/jana/Desktop/R_dat/comm_cluster_compositions.pdf',width = 10,height = 10)
p
dev.off()


# Row names
trownames = hm_dat$cluster

# Convert to a matrix
hm_dat = as.matrix(hm_dat[,-1,with=F])
row.names(hm_dat) = trownames

# Set color map
cols = rev(brewer.pal(11,'Spectral'))
cmap = colorRampPalette(cols)

# Hierarchical clustering on rows with Ward's linkage
tdist = as.dist(1-cor(t(hm_dat), method="spearman"))
hr <- hclust(tdist, method="ward.D2")
co_r <- order.optimal(tdist, hr$merge)
hr$merge = co_r$merge
hr$order = co_r$order

# Order rows in heatmap according to clustering
order_heatmap_zscored = row.names(hm_dat)[hr$order]

# Hierarchical clustering on columns with Ward's linkage
tdist = as.dist(1-cor((hm_dat), method="spearman"))
hc <- hclust(tdist, method="ward.D2")
co_c <- order.optimal(tdist, hc$merge)
hc$merge = co_c$merge
hc$order = co_c$order

# Z-score data
p_dat = scale(hm_dat)

# Censor z-score at 2
p_dat[p_dat > 2] =2
p_dat[p_dat < -2] =-2

order_stroma = hr$labels[hr$order]


pdf(file="/home/jana/Desktop/R_dat/stroma_node_heatmap_k20_zurich.pdf", width=10, height=10)

heatmap.2(p_dat,
          scale ='none',
          trace = "none",
          col=cmap(75),
          Rowv=as.dendrogram(hr),
          Colv=as.dendrogram(hc),
          density.info ='none',
          cexRow=0.6,
          cexCol=0.6,
          margins=c(4,8),
          xlab = 'Markers',
          ylab ='Cluster',
          main = 'PG_norm_slide',
          colCol = c(rev(rev(mycols)[cluster_order %in% c("41","3" , "39","7","2" ,"21","28","18","5","1","16")]),'black'), #everything above 36 is -1 because 36 dropes out
          colRow = col_vector) #mycols_basel for small clusters

dev.off()






# #Enrichment of stromal community clusters and ME groups
# enrichment = unique(nodules_wide[,c('groups','cluster','Community','core')])
# enrichment[,nr_both := .N, by = c('cluster','groups')]
# enrichment[,perc_ME := nr_both/.N, by = c('groups')]
# enrichment[,perc_clus := nr_both/.N, by = c('cluster')]
# enrichment = unique(enrichment[,c('cluster','groups','perc_ME','perc_clus')])
# enrichment$cluster = factor(enrichment$cluster,hr$labels[hr$order])
# enrichment$groups = factor(enrichment$groups)
# test = enrichment[,c('perc_clus','cluster','groups')]
# 
# #Fraction of patients containing at least 1
# enrichment = unique(nodules_wide[,c('groups','cluster','patientcode')])
# enrichment[,both := .N, by = c('cluster','groups')]
# enrichment[,frac := both/length(unique(patientcode)), by = c('groups')]
# enrichment = unique(enrichment[,c('groups','cluster','frac')])
# enrichment$cluster = factor(enrichment$cluster,hr$labels[hr$order])
# enrichment$groups = factor(enrichment$groups)
# enrichment = merge(enrichment,test,by = c('groups','cluster'))



# p4 <- ggplot(enrichment,aes(y=cluster,x=groups))+
#   geom_point(aes(colour = perc_clus, 
#                  size =frac))  +   
# scale_color_gradient2(low = "blue",  
#                      mid = "white",
#                      high = "red",
#                      name = "Fraction of stromal community in TME group")+       
# scale_size(range = c(1, 15),name = "Fraction of patients in TME containing at least 1") +
#       theme(axis.text.y=element_text(color = col_vector[as.numeric(hr$labels[hr$order])]),panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
# panel.background = element_blank(), axis.line = element_line(colour = "black"))
# 
# pdf('/home/jana/Desktop/R_dat/stromalComm_TME_groups_flipped.pdf',width = 20, height = 10)
# p4
# dev.off()


#Clustergrams
nodules_wide = merge(nodules_wide,Sample_metadata[,c('core','patientcode')],by = 'core')
neighb_clusters = fread('/home/jana/Desktop/Revisions/neighborhood_zurich_clusters.csv',header = T)
names(neighb_clusters) = c('core','groups')
nodules_wide = merge(nodules_wide,neighb_clusters, by = 'core')
nodules_wide$groups = factor(nodules_wide$groups )
enrichment = unique(nodules_wide[,c('cluster','Community','core')])
enrichment[,both := .N, by = c('cluster','core')]
enrichment[,frac_patient := both/.N, by = c('core')]
enrichment = unique(enrichment[,c('core','cluster','frac_patient')])
d = dcast.data.table(enrichment,formula = 'core  ~ cluster',value.var = 'frac_patient',fill = 0)
d_mat = as.matrix(d[,-'core'])
rownames(d_mat) = d$core
d = merge(d,neighb_clusters,by = 'core')

hr = hclust(dist(d_mat), method = "ward.D2")
clusters = dendextend::cutree(hr, k = 11)

cnames = names(clusters)
n_clusters = data.table(cnames)
names(n_clusters) = 'core'
n_clusters$cluster = unlist(clusters)
n_clusters_orig = n_clusters

d = merge(d,asigned,by = 'core')
d = merge(d,unique(Sample_metadata[,c('core','clinical_type')]),by = 'core')

h = Heatmap(d_mat, name = "Clustergram", km = 1, col = colorRamp2(c(0, 1), c("white", "red")),
     show_row_names = T, show_column_names =  T, clustering_method_rows = "ward.D2",clustering_method_columns = "ward.D2",split = clusters)+

Heatmap(factor(d$groups), name = "mArc_groups", show_row_names = FALSE, width = unit(10, "mm"), col = structure(col_vector, names = c(as.character(1:10)))) +
Heatmap(factor(d$patient_pheno), name = "SCP", show_row_names = FALSE, width = unit(10, "mm"), col = structure(mycols_patient[sort(unique(d$patient_pheno))], names = as.character(sort(unique(d$patient_pheno)))))+
  Heatmap(factor(d$clinical_type), name = "clinical_type", show_row_names = FALSE, width = unit(10, "mm"), col = structure(mycols_clinical, names = c('HR-HER2+','HR+HER2-','HR+HER2+','TripleNeg')))

o_stroma = column_order(h)
o_patients = names(clusters[unlist(row_order(h))])

pdf('/home/jana/Desktop/R_dat/levels_stromalcommunities_ME_colors.pdf',width = 10, height = 30)
h
dev.off()

#icons
icon = merge(nodules_orig,n_clusters_orig,by = 'core')
icon = unique(icon[,c('Pheno','ncells','core','Community','cluster')])
icon[,tot := sum(as.double(ncells)), by = c('cluster','Pheno')]
icon[,avg := tot/sum(tot), by = c('cluster')]


cp <- coord_polar(theta = "y", start=0)
cp$is_free <- function() TRUE

bp<- ggplot(icon, aes(x="", y=avg, fill=factor(Pheno,levels = c(cluster_order[cluster_order %in% c("41","3" , "39","7","2" ,"21","28","18","5","1","16")],'100'))))+
geom_bar(width = 1, stat = "identity")+
  cp+
  facet_wrap(~cluster, ncol = 5)+
  scale_fill_manual("Clusters",values =  c(rev(mycols)[cluster_order %in% c("41","3" , "39","7","2" ,"21","28","18","5","1","16")],'black'))+
    theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

c = bp +   coord_polar("y", start=0)

pdf('/home/jana/Desktop/R_dat/circle_icons.pdf',width = 10, height = 20)
bp
dev.off()

enrichment = unique(nodules_wide[,c('cluster','Community','core','patientcode')])
enrichment[,both := .N, by = c('cluster','patientcode')]
enrichment[,frac_patient := both/.N, by = c('patientcode')]
enrichment = unique(enrichment[,c('patientcode','cluster','frac_patient')])
d_new = dcast.data.table(enrichment,formula = 'patientcode  ~ cluster',value.var = 'frac_patient',fill = 0)
d_mat = as.matrix(d_new[,-'patientcode'])
rownames(d_mat) = d_new$patientcode
hr = hclust(dist(d_mat), method = "ward.D2")

d = merge(d,Sample_metadata[,c('core','patientcode')],by = 'core')
d = d[order(match(d$patientcode,hr$labels[hr$order])),]

d_mat = as.matrix(d[,-c('core','groups','patientcode')])
rownames(d_mat) = d$core
h = Heatmap(d_mat, name = "Clustergram", km = 1, col = colorRamp2(c(0, 1), c("white", "red")),
     show_row_names = T, show_column_names =  T,cluster_rows = FALSE,clustering_method_columns = "ward.D2")+
  Heatmap(factor(d$group), name = "TME", show_row_names = FALSE, width = unit(10, "mm"), col = structure(col_vector, names = c(as.character(1:10))))+
  Heatmap(factor(d$patientcode), name = "Patient", show_row_names = FALSE, width = unit(10, "mm"), col = structure(c(col_vector,'black'), names = c(unique(d$patientcode))))

pdf('/home/jana/Desktop/R_dat/levels_ordered_patient.pdf',width = 10, height = 20)
h
dev.off()


```

#SCP stromal region enrichment
```{r}
cors = merge(n_clusters_orig,asigned,by = 'core')


cors[,nr_both := .N, by = c('cluster','patient_pheno')]
cors[,perc_ME := nr_both/.N, by = c('cluster')]
cors[,perc_CT := nr_both/.N, by = c('patient_pheno')]

cors$cluster = factor(cors$cluster, levels = as.character(1:11))
cors$patient_pheno = factor(cors$patient_pheno)
colnames(cors)[1:3] = c('patientcode','StromalComm_groups','SCP_groups')

#plot
p4 <- ggplot(cors,aes(y=StromalComm_groups,x=SCP_groups))+
  geom_point(aes(colour = perc_ME, 
                 size =perc_CT))  +   
scale_color_gradient2(low = "blue",  
                     mid = "white",
                     high = "red",
                     name = "Fraction of Comm_cluster in SCP group")+       
scale_size(range = c(1, 15),name = "Fraction of SCP in Comm_cluster group") +
      theme(axis.text.x=element_text(color = c(mycols_patient[sort(as.numeric(levels(cors$SCP_groups)))])))

pdf('/home/jana/Desktop/R_dat/Zurich_enrichment_commclusters_SCP_groups.pdf',width = 20, height = 10)
p4
dev.off()


#Loop through all SCP/TME patient groups and test for all response types each one contains whether there is a significant enrichment
overview = list()
counter = 1
for (i in unique(cors$StromalComm_groups)){
  logic_vector = cors$StromalComm_groups == i
  MEs = unique(cors$SCP_groups[logic_vector])
  ME_vectors = lapply(MEs, function(x){cors$SCP_groups == x})
  res = lapply(ME_vectors, function(x){fisher.test(logic_vector,x,alternative = 'greater')})
  p = unlist(lapply(res, function(x){x$p.value}))
  CT_name = rep(i,length(MEs))
  ME_name = as.character(MEs)
  #Correct for multiple testing
  adjusted_p = p.adjust(p, method = 'bonferroni', n = length(p))
  overview[[counter]] = cbind(CT_name,ME_name,adjusted_p)
  
  counter = counter + 1
}

d = data.table(do.call(rbind,overview))
colnames(d) = c('StromalCommRegion','SCP_groups','adjusted_p')
fwrite(d,file = '/home/jana/Desktop/R_dat/enrichment_p_vals_SCP_styromal_region.csv',col.names = T)


#Clinical
cors = merge(n_clusters_orig,unique(Sample_metadata[,c('core','clinical_type')]),by = 'core')
cors = cors[clinical_type != '',]

cors[,nr_both := .N, by = c('cluster','clinical_type')]
cors[,perc_ME := nr_both/.N, by = c('cluster')]
cors[,perc_CT := nr_both/.N, by = c('clinical_type')]

cors$cluster = factor(cors$cluster, levels = as.character(1:11))
cors$clinical_type = factor(cors$clinical_type)
colnames(cors)[1:3] = c('patientcode','StromalComm_groups','clinical_type')

#plot
p4 <- ggplot(cors,aes(y=StromalComm_groups,x=clinical_type))+
  geom_point(aes(colour = perc_ME, 
                 size =perc_CT))  +   
scale_color_gradient2(low = "blue",  
                     mid = "white",
                     high = "red",
                     name = "Fraction of Comm_cluster in clinical_type group")+       
scale_size(range = c(1, 15),name = "Fraction of clinical_type in Comm_cluster group") +
      theme(axis.text.x=element_text(color = c(mycols_clinical)))

pdf('/home/jana/Desktop/R_dat/Zurich_enrichment_commclusters_clinical_groups.pdf',width = 20, height = 10)
p4
dev.off()


#Loop through all SCP/TME patient groups and test for all response types each one contains whether there is a significant enrichment
overview = list()
counter = 1
for (i in unique(cors$StromalComm_groups)){
  logic_vector = cors$StromalComm_groups == i
  MEs = unique(cors$clinical_type[logic_vector])
  ME_vectors = lapply(MEs, function(x){cors$clinical_type == x})
  res = lapply(ME_vectors, function(x){fisher.test(logic_vector,x,alternative = 'greater')})
  p = unlist(lapply(res, function(x){x$p.value}))
  CT_name = rep(i,length(MEs))
  ME_name = as.character(MEs)
  #Correct for multiple testing
  adjusted_p = p.adjust(p, method = 'bonferroni', n = length(p))
  overview[[counter]] = cbind(CT_name,ME_name,adjusted_p)
  
  counter = counter + 1
}

d = data.table(do.call(rbind,overview))
colnames(d) = c('StromalCommRegion','clinical_type','adjusted_p')
fwrite(d,file = '/home/jana/Desktop/R_dat/enrichment_p_vals_clinical_styromal_region.csv',col.names = T)


```

#Center periphery
```{r}
nodules_wide = merge(unique(Sample_metadata[,c('core','patientcode','location')]),nodules_wide,by = 'core')


cluster_loc = nodules_wide[,c('cluster','core','Community','location')]
cluster_loc = cluster_loc[!location %in% c('NORMAL','METASTASIS','[]'),]
cluster_loc[,count := .N, by = c('cluster','location')]
cluster_loc[,frac_cluster := count/.N, by = 'cluster']
cluster_loc[,frac_location := count/.N, by = 'location']
cluster_loc = unique(cluster_loc[,c('cluster','location','frac_cluster')])



p <- ggplot(cluster_loc, aes(x=factor(cluster,levels = hr$labels[hr$order]), y=frac_cluster, fill=factor(location,levels = c('CENTER','PERIPHERY','NORMAL','METASTASIS')))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values = c('red','blue','grey','black'))+ # rev(mycols)[!cluster_order %in% c(1,3:5,7:8,11,13,22,25:26,33:34)]
  labs(fill = "Location")+
  coord_flip()+
  xlab("loc")+
  ylab("Frac cluster")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=col_vector[as.numeric(hr$labels[hr$order])]))+
  ggtitle('Location composition')


pdf('/home/jana/Desktop/R_dat/zurich_community_location_stroma.pdf',width = 10, height = 20)
p
dev.off()

```

#Correlation among epi comm
```{r}

s = unique(nodules_wide[,c('patientcode','cluster','Community','core')])
s[,nr_both := .N, by = c('cluster','core')]
s = merge(s,unique(Sample_metadata[,c('core','area')]),by = 'core')
s[,nodule_area := nr_both/area, by = 'core']
s[,nodule_area_patient := mean(nodule_area),by = c('patientcode','cluster')]
s = unique(s[,c('patientcode','cluster','nodule_area_patient')])
s = dcast.data.table(s,'patientcode ~ cluster',fill = 0)

o_s = column_order(h)
s = s[,c('patientcode',as.character(o_s$Clustergram)),with = F]

colnames(s)[-c(1)] = paste0('cluster_',colnames(s)[-c(1)])

#Change Unit so the values aren't all super small
s = cbind(s[,c(1)],data.table(as.matrix(s[,-c(1)]) * 100000))


s_mat = as.matrix(s[,-'patientcode'])
rownames(s_mat) = s$patientcode

incor = cor(s_mat)

pdf('/home/jana/Desktop/R_dat/corr_stromal_zurich.pdf',width = 20,height = 20)
corrplot(cor(s_mat), method = "color",col=colorRampPalette(c("blue","white","red"))(200))
dev.off()
```
#Neighborhood according to stromal communities
```{r}
#d_mat from clustered clustergram stroma


clustergram_dat_meta = clustergram_dat_meta[core %in% o_patients,]
clustergram_dat_meta = clustergram_dat_meta[order(match(core,o_patients))]

mat = mat[clustergram_dat_meta$core,]


splitting = clusters
splitting = splitting[order(match(names(splitting),clustergram_dat_meta$core))]
splitting = splitting[names(splitting) %in% clustergram_dat_meta$core]


h = Heatmap(mat, name = "Clustergram", km = 1, col = colorRamp2(c(-1, 0, 1), c("blue", "white", "red")),
     show_row_names = TRUE, show_column_names =  TRUE, cluster_rows = F,clustering_method_columns = "ward.D2",split = splitting)+   #  row_order = rev(order_stacked), cluster_rows = FALSE

 Heatmap(factor(clustergram_dat_meta$location), name = "Location", show_row_names = FALSE, width = unit(10, "mm"), col = structure(c("white","red","blue","black"), names = c('[]','CENTER','PERIPHERY','METASTASIS')))+ 
  
Heatmap(factor(clustergram_dat_meta$grade), name = "Grade", show_row_names = FALSE, width = unit(10, "mm"), col = structure(c("green","blue","red",'black'), names = c('1','2','3','METASTASIS')))+ 
  
Heatmap(factor(clustergram_dat_meta$PTNM_M), name = "Met", show_row_names = FALSE, width = unit(10, "mm"), col = structure(c("black","gray",'white'), names = c('M1','M0_IPLUS','M0')))+ 
  
  Heatmap(factor(clustergram_dat_meta$patientcode), name = "Patient", show_row_names = T, width = unit(10, "mm"), col = structure(c(col_vector,'black','gray'), names = levels(factor(clustergram_dat_meta$patientcode))))


pdf('/home/jana/Desktop/R_dat/neighborhood_accordingtoComm.pdf',width = 90, height = 60)
h
dev.off()


#Enrichment analysis for neighborhood interactions in stromal community groups

n_clusters_orig = merge(n_clusters_orig,clustergram_dat,by = 'core')

n_clusters_orig$cluster = as.factor(n_clusters_orig$cluster)

#Loop through all SCP patient groups and test for all TMEs each one contains whether there is a significant enrichment
overview = list()
counter = 1
for (i in 4:ncol(n_clusters_orig)){
  
  
  cur = as.matrix(n_clusters_orig[,eval(i),with =F])
  cur[cur == -1] = 0
  if (sum(cur)> 0){
    cur = as.factor(cur)
  
    #only for positive association
    res = lapply(unique(n_clusters_orig$cluster), function(x){fisher.test(cur == 1,n_clusters_orig$cluster == x,alternative = 'greater',simulate.p.value=TRUE)})
    p = unlist(lapply(res, function(x){x$p.value}))
      
    
    interaction_name = rep(names(n_clusters_orig)[i],length(unique(n_clusters_orig$cluster)))
    group_name = unique(n_clusters_orig$cluster)
    #Correct for multiple testing of different TMEs
    adjusted_p = p.adjust(p, method = 'bonferroni', n = length(p))
    overview[[counter]] = cbind(interaction_name,group_name,adjusted_p)
    
    counter = counter + 1
    }
}

#Write out overview of results
d = data.table(do.call(rbind,overview))
d = d[adjusted_p < 0.05,]
fwrite(d,file = '/home/jana/Desktop/R_dat/Zurich_enrichment_StromalCommGroups_significantInteractions_positive.csv',col.names = T)


```
#Correlation stroma and epi comm
```{r}
#epi
e = unique(nodules_wide[,c('patientcode','cluster','Community','core')])
e[,nr_both := .N, by = c('cluster','core')]
e = merge(e,unique(Sample_metadata[,c('core','area')]),by = 'core')
e[,nodule_area := nr_both/area, by = 'core']
e[,nodule_area_patient := mean(nodule_area),by = c('patientcode','cluster')]
e = unique(e[,c('patientcode','cluster','nodule_area_patient')])
e = dcast.data.table(e,'patientcode ~ cluster',fill = 0)

e = e[,c('patientcode',as.character(o_epi$Clustergram)),with = F]


colnames(e)[-c(1)] = paste0('cluster_',colnames(e)[-c(1)])

#Change Unit so the values aren't all super small
e = cbind(e[,c(1)],data.table(as.matrix(e[,-c(1)]) * 100000))

e_mat = as.matrix(e[,-'patientcode'])
rownames(e_mat) = e$patientcode

#stroma
s = unique(nodules_wide[,c('patientcode','cluster','Community','core')])
s[,nr_both := .N, by = c('cluster','core')]
s = merge(s,unique(Sample_metadata[,c('core','area')]),by = 'core')
s[,nodule_area := nr_both/area, by = 'core']
s[,nodule_area_patient := mean(nodule_area),by = c('patientcode','cluster')]
s = unique(s[,c('patientcode','cluster','nodule_area_patient')])
s = dcast.data.table(s,'patientcode ~ cluster',fill = 0)

s = s[,c('patientcode',as.character(o_stroma$Clustergram)),with = F]


colnames(s)[-c(1)] = paste0('stroma_cluster_',colnames(s)[-c(1)])

#Change Unit so the values aren't all super small
s = cbind(s[,c(1)],data.table(as.matrix(s[,-c(1)]) * 100000))

s_mat = as.matrix(s[,-'patientcode'])
rownames(s_mat) = s$patientcode


s_mat = s_mat[rownames(s_mat)[rownames(s_mat) %in% rownames(e_mat)],]
e_mat = e_mat[rownames(e_mat)[rownames(e_mat) %in% rownames(s_mat)],]



crosscor = cor(e_mat,s_mat)

combcorr = cor(cbind(e_mat,s_mat))


hr = hclust(dist(t(cbind(e_mat,s_mat))), method = "ward.D2")


pdf('/home/jana/Desktop/R_dat/Zurich_corr_stromal_epi_comm_patient_level.pdf',width = 20,height = 20)
corrplot(cor(cbind(e_mat,s_mat)), method = "color",col=colorRampPalette(c("blue","white","red"))(200))#[,hr$labels[hr$order]]
dev.off()
```

#Correlate SCP and stromal neighborhood regions
```{r}
regions = merge(n_clusters_orig,unique(Sample_metadata[,c('core','patientcode')]),by = 'core')
regions = dcast.data.table(regions, formula = 'patientcode ~ cluster')
mat_regions = as.matrix(regions[,-'patientcode'])
rownames(mat_regions) = regions$patientcode

#mat from other script
mat_regions = mat_regions[rownames(mat_regions)[rownames(mat_regions) %in% rownames(mat)],]
mat = mat[rownames(mat)[rownames(mat) %in% rownames(mat_regions)],]

colnames(mat_regions)= paste0('StromalRegion_',colnames(mat_regions))

hr = hclust(dist(t(cbind(mat,mat_regions))), method = "ward.D2")

#Correlate mArcs
pdf('/home/jana/Desktop/R_dat/Corr_SCP_stromalregion_clustered.pdf')
corrplot(cor(cbind(mat,mat_regions)[,hr$labels[hr$order]]), method = "circle",col=colorRampPalette(c("blue","white","red"))(200))
dev.off()


```

#Correlation on cell level ( how often do they share cells)
```{r}

epi = merge(unique(nodules_orig[,c('CellId','Community','core')]),nodules_wide[,c('core','Community','cluster')],by = c('core','Community'))
names(epi)[names(epi) == 'Community'] = 'Epi_community'
names(epi)[names(epi) == 'cluster'] = 'Epi_cluster'

stroma = merge(unique(nodules_orig[,c('CellId','Community','core')]),nodules_wide[,c('core','Community','cluster')],by = c('core','Community'))
names(stroma)[names(stroma) == 'Community'] = 'Stromal_community'
names(stroma)[names(stroma) == 'cluster'] = 'Stromal_cluster'

both = merge(epi,stroma, by = c('core','CellId'))
both[,n_both := .N , by = c('Epi_cluster','Stromal_cluster')]
both[,frac_epi := n_both/.N , by = c('Epi_cluster')]
both[,frac_stroma := n_both/.N , by = c('Stromal_cluster')]

both$Stromal_cluster = factor(both$Stromal_cluster, levels = o_stroma$Clustergram) #order_stroma
both$Epi_cluster = factor(both$Epi_cluster, levels = o_epi$Clustergram)

both = unique(both[,c('Epi_cluster','Stromal_cluster','n_both')])
p4 <- ggplot(both,aes(y=factor(Epi_cluster),x=factor(Stromal_cluster)))+
  geom_point(aes(colour = n_both, 
                 size = n_both))  +   
scale_color_gradient2(low = "blue",  
                     mid = "white",
                     high = "red",
                     name = "abs number")+       
scale_size(range = c(1, 15),name = "abs number") +
  theme_dark()

pdf('/home/jana/Desktop/R_dat/community_enrichment_cellLevel_Zurich.pdf',width = 20, height = 10)
p4
dev.off()


```


#Spatial figure
```{r}
#Out of all images of the patients containing at least 1 image of a SCP group, how many are in each group
co = merge(asigned,unique(Sample_metadata[,c('core','patientcode')]),by = 'core');
co = dcast.data.table(co,'patientcode ~ patient_pheno')
nr_patients = as.matrix(co[,-'patientcode'])
nr_patients[nr_patients > 1] = 1
rownames(nr_patients) = co$patientcode
nr_patients = colSums(nr_patients)
table_nr = as.data.table(nr_patients)
table_nr$Var1 = names(nr_patients)


amount = list()
actual_amount = list()
for (i in c(1:4,6:(ncol(co)))){

  cur_nr = as.vector(as.matrix(co[,as.character(eval(i)),with = F]))
  patients = co[cur_nr > 0,]
  patients_mat = as.matrix(patients[,-'patientcode'])
  rownames(patients_mat) = patients$patientcode
  patients_mat[patients_mat > 1] = 1
  cur_amount = colSums(patients_mat)
  if (nrow(patients_mat) > 1){
    cur_amount[as.character(eval(i))] = length(which(rowSums(patients_mat[,colnames(patients_mat)[colnames(patients_mat) != as.character(eval(i))]]) == 0))}
  else{cur_amount[as.character(eval(i))] = length(which(sum(patients_mat[,colnames(patients_mat)[colnames(patients_mat) != as.character(eval(i))]]) == 0))}
  amount = rbind(amount,cur_amount)
  
  actual_amount = rbind(actual_amount,(colSums(patients[,-'patientcode'])/(sum(colSums(patients[,-'patientcode'])))))

}



amount = matrix(unlist(amount), ncol = ncol(amount), byrow = F)
rownames(amount) = as.character(c(1:4,6:(ncol(co))))
colnames(amount) = as.character(c(1:4,6:(ncol(co))))

m_amount = melt(amount)

m_amount = merge(m_amount,table_nr,by = 'Var1')

m_amount = data.table(m_amount)
m_amount[,fraction_images := value/nr_patients]


actual_amount = matrix(unlist(actual_amount), ncol = ncol(actual_amount), byrow = F)
rownames(actual_amount) = as.character(c(1:4,6:(ncol(co))))
colnames(actual_amount) = as.character(c(1:4,6:(ncol(co))))
m_act = melt(actual_amount)

m_amount = merge(m_amount,m_act,by = c('Var1','Var2'))

pdf('/home/jana/Desktop/R_dat/probability_mixing.pdf',width = 13)
ggplot(m_amount, aes(x = factor(Var2), y = factor(Var1))) + 
  geom_point(aes(size =value.y,
                 alpha = fraction_images,
                 color = factor(Var2))) + 
  scale_color_manual(values = mycols_patient[unique(m_amount$Var1)])+
  #scale_color_gradient(low="white", high="red",name = "Out of patients containing 1, fraction of images in each group") +
  scale_size(range = c(1, 15),name = "Out of patients containing y, fraction containing both x and y") +
  theme(axis.text.y=element_text(color = c(mycols_patient[unique(m_amount$Var1)])))
dev.off()



co = merge(asigned,unique(Sample_metadata[,c('core','patientcode')]),by = 'core');
co$patient_pheno = factor(co$patient_pheno)
co = merge(co,n_clusters_orig,by = 'core')

pdf('/home/jana/Desktop/R_dat/mosaic.pdf',width = 10,height = 10)
 ggplot(data = co) +
   geom_mosaic(aes(x = product(patient_pheno,cluster), fill=patient_pheno), na.rm=TRUE) +
   scale_fill_manual(values = mycols_patient[unique(m_amount$Var1)])
dev.off()


# ggparallel(vars=list("patient_pheno", "patientcode"), data=co) +
#   theme(legend.position="none") +
#   #scale_fill_manual(values = mycols_patient[unique(m_amount$Var1)]) +
#   #scale_colour_manual(values = rep(c("Orange", "Steelblue"), 14))


#Stromal regions


co2 = merge(n_clusters_orig,unique(Sample_metadata[,c('core','patientcode')]),by = 'core');
co2 = dcast.data.table(co2,'patientcode ~ cluster')
nr_patients = as.matrix(co2[,-'patientcode'])
nr_patients[nr_patients > 1] = 1
rownames(nr_patients) = co2$patientcode
nr_patients = colSums(nr_patients)
table_nr = as.data.table(nr_patients)
table_nr$Var1 = names(nr_patients)


amount = list()
actual_amount = list()
for (i in c(1:11)){

  cur_nr = as.vector(as.matrix(co2[,as.character(eval(i)),with = F]))
  patients = co2[cur_nr > 0,]
  patients_mat = as.matrix(patients[,-'patientcode'])
  rownames(patients_mat) = patients$patientcode
  patients_mat[patients_mat > 1] = 1
  cur_amount = colSums(patients_mat)
  if (nrow(patients_mat) > 1){
    cur_amount[as.character(eval(i))] = length(which(rowSums(patients_mat[,colnames(patients_mat)[colnames(patients_mat) != as.character(eval(i))]]) == 0))}
  else{cur_amount[as.character(eval(i))] = length(which(sum(patients_mat[,colnames(patients_mat)[colnames(patients_mat) != as.character(eval(i))]]) == 0))}
  amount = rbind(amount,cur_amount)
  
  actual_amount = rbind(actual_amount,(colSums(patients[,-'patientcode'])/(sum(colSums(patients[,-'patientcode'])))))

}



amount = matrix(unlist(amount), ncol = ncol(amount), byrow = F)
rownames(amount) = as.character(c(1:11))
colnames(amount) = as.character(c(1:11))

m_amount = melt(amount)

m_amount = merge(m_amount,table_nr,by = 'Var1')

m_amount = data.table(m_amount)
m_amount[,fraction_images := value/nr_patients]


actual_amount = matrix(unlist(actual_amount), ncol = ncol(actual_amount), byrow = F)
rownames(actual_amount) = as.character(c(1:11))
colnames(actual_amount) = as.character(c(1:11))
m_act = melt(actual_amount)

m_amount = merge(m_amount,m_act,by = c('Var1','Var2'))

pdf('/home/jana/Desktop/R_dat/probability_mixing_stroma_regions.pdf',width = 20)
ggplot(m_amount, aes(x = factor(Var2), y = factor(Var1))) + 
  geom_point(shape = 21,color = 'black',aes(size =value.y,
                 alpha = fraction_images,
                 fill = fraction_images)) + 
  #scale_color_manual(values = mycols_patient[unique(m_amount$Var1)])+
  scale_fill_gradient(low="white", high="red",name = "Out of patients containing 1, fraction of images in each group") +
  scale_size(range = c(1, 15),name = "Out of patients containing 1, fraction of images in each group") 
dev.off()



#combined
names(co)[2:length(names(co))] = paste0('SCP_',names(co)[2:length(names(co))])
names(co2)[2:length(names(co2))] = paste0('StromalRegion_',names(co2)[2:length(names(co2))])
co_comb = merge(co,co2,by = 'patientcode')

nr_patients = as.matrix(co_comb[,-'patientcode'])
nr_patients[nr_patients > 1] = 1
rownames(nr_patients) = co_comb$patientcode
nr_patients = colSums(nr_patients)
table_nr = as.data.table(nr_patients)
table_nr$Var1 = names(nr_patients)


amount = list()
actual_amount =
tot_amount_SCP = list()
tot_amount_stroma = list()
for (i in colnames(co_comb)[colnames(co_comb) != 'patientcode']){
  
  cur_nr = as.vector(as.matrix(co_comb[,eval(i),with = F]))
  patients = co_comb[cur_nr > 0,]
  

  patients_mat = as.matrix(patients[,-'patientcode'])
  rownames(patients_mat) = patients$patientcode
  patients_mat[patients_mat > 1] = 1
  cur_amount = colSums(patients_mat)
  cur_code = str_split(i,'_')[[1]][1]
  
  if (nrow(patients_mat) > 1){
    #cur_amount[as.character(eval(i))] = length(which(rowSums(patients_mat[,colnames(patients_mat)[colnames(patients_mat) != as.character(eval(i))]]) == 0))}
    cur_amount[as.character(eval(i))] = length(which(rowSums(patients_mat[,colnames(patients_mat)[(colnames(patients_mat) != as.character(eval(i))) & str_detect(colnames(patients_mat),cur_code)]]) == 0))}
  else{cur_amount[as.character(eval(i))] = length(which(sum(patients_mat[,colnames(patients_mat)[(colnames(patients_mat) != as.character(eval(i))) & str_detect(colnames(patients_mat),cur_code)]]) == 0))}
  amount = rbind(amount,cur_amount)
  
  scp = colSums(patients[,str_detect(colnames(patients),'SCP'),with = F])/(sum(colSums(patients[,str_detect(colnames(patients),'SCP'),with = F])))
  stroma = colSums(patients[,str_detect(colnames(patients),'StromalRegion'),with = F])/(sum(colSums(patients[,str_detect(colnames(patients),'StromalRegion'),with = F])))
  actual_amount = rbind(actual_amount,c(scp,stroma))

  tot_amount_SCP = rbind(tot_amount_SCP,c(i,sum(colSums(patients[,c(colnames(patients)[str_detect(colnames(patients),'SCP')]),with = F])))) #Are both identical
  # tot_amount_stroma = rbind(tot_amount_stroma,c(i,sum(colSums(patients[,c(colnames(patients)[str_detect(colnames(patients),'StromalRegion')]),with = F])))) #Are both identical
}

cnames = colnames(amount)
amount = matrix(unlist(amount), ncol = ncol(amount), byrow = F)
rownames(amount) = cnames
colnames(amount) = cnames

m_amount = melt(amount)

m_amount = merge(m_amount,table_nr,by = 'Var1')

m_amount = data.table(m_amount)
m_amount[,fraction_images := value/nr_patients]

actual_amount = matrix(unlist(actual_amount), ncol = ncol(actual_amount), byrow = F)
rownames(actual_amount) = cnames
colnames(actual_amount) = cnames
m_act = melt(actual_amount)

m_amount = merge(m_amount,m_act,by = c('Var1','Var2'))


order_hierarchy = c('SCP_1','SCP_2','SCP_3','SCP_4','SCP_5','SCP_6','SCP_7','SCP_8','SCP_9','SCP_10','SCP_11','SCP_12','SCP_13','SCP_14','SCP_15','SCP_16','SCP_17','SCP_18','StromalRegion_2','StromalRegion_1','StromalRegion_6','StromalRegion_4','StromalRegion_10','StromalRegion_5','StromalRegion_8','StromalRegion_11','StromalRegion_3','StromalRegion_7','StromalRegion_9')
m_amount$Var1 = factor(m_amount$Var1,levels = order_hierarchy)
m_amount$Var2 = factor(m_amount$Var2,levels = order_hierarchy)

pdf('/home/jana/Desktop/R_dat/probability_mixing_stroma_regions.pdf',width = 20,height = 15)
ggplot(m_amount, aes(x = factor(Var2), y = factor(Var1))) + 
  geom_point(shape = 21,color = 'black',aes(size =value.y,
                 #alpha = fraction_images,
                 fill = fraction_images)) + 
  #scale_color_manual(values = mycols_patient[unique(m_amount$Var1)])+
  scale_fill_gradient(low="white", high="red",name = "Out of patients containing 1, fraction of images in each group") +
  scale_size(range = c(1, 15),name = "Out of patients containing 1, fraction of images in each group") +
  theme(axis.text.x = element_text(angle = 90))
dev.off()


#Center periphery KLdiv

kldiv_ordered = data.table(names(unlist(kldiv)))
kldiv_ordered$kldiv = as.vector(unlist(kldiv))
names(kldiv_ordered)[1] = 'core'
kldiv_ordered$core = unlist(lapply(strsplit(kldiv_ordered$core,'[.]'), function(x){paste(x[3:4],collapse = '.')}))
kldiv_ordered = merge(kldiv_ordered,unique(Sample_metadata[,c('core','location')]), by = 'core')

p <- ggplot(kldiv_ordered, aes(x=factor(location), y=kldiv)) + 
  geom_boxplot()+
  geom_point(size=2, alpha=1)+
  #stat_summary( fun.y = "mean",geom="point",colour = "black", size = 5)+
  #stat_summary(aes(group=grade), fun.y=mean, geom="line", colour="green")+
  ylab("KL div")+
  xlab("Patientgroup")+
  theme(panel.background = element_blank())+
  ggtitle('Cores assigned to patient group')




#Boxplots stroma and SCP


#Patientgroups

kldiv_ordered = data.table(names(unlist(kldiv)))
kldiv_ordered$kldiv = as.vector(unlist(kldiv))
names(kldiv_ordered)[1] = 'core'
kldiv_ordered$core = unlist(lapply(strsplit(kldiv_ordered$core,'[.]'), function(x){paste(x[3:4],collapse = '.')}))
kldiv_ordered = merge(kldiv_ordered,asigned, by = 'core')


sh = merge(shannon_core,asigned)


p <- ggplot(kldiv_ordered, aes(x=factor(patient_pheno), y=kldiv)) + 
  geom_boxplot()+
  geom_point(size=2, alpha=1)+
  #stat_summary( fun.y = "mean",geom="point",colour = "black", size = 5)+
  #stat_summary(aes(group=grade), fun.y=mean, geom="line", colour="green")+
  ylab("KL div to patietn average of core")+
  xlab("Patientgroup")+
  theme(panel.background = element_blank())+
  ggtitle('Cores assigned to patient group')

pdf('/home/jana/Desktop/R_dat/CoreKLdiv_to_patientMean_perAssignedPatientgroup.pdf')
p
dev.off()


#Stromal regions

kldiv_ordered = data.table(names(unlist(kldiv)))
kldiv_ordered$kldiv = as.vector(unlist(kldiv))
names(kldiv_ordered)[1] = 'core'
kldiv_ordered$core = unlist(lapply(strsplit(kldiv_ordered$core,'[.]'), function(x){paste(x[3:4],collapse = '.')}))
kldiv_ordered = merge(kldiv_ordered,n_clusters_orig, by = 'core')
kldiv_ordered$cluster = factor(kldiv_ordered$cluster,levels = c(2,1,6,4,10,5,8,11,3,7,9))

sh = merge(shannon_core,n_clusters_orig)
sh$cluster = factor(sh$cluster,levels = c(2,1,6,4,10,5,8,11,3,7,9))

p <- ggplot(kldiv_ordered, aes(x=factor(cluster), y=kldiv)) + 
  geom_boxplot()+
  geom_point(size=2, alpha=1)+
  #stat_summary( fun.y = "mean",geom="point",colour = "black", size = 5)+
  #stat_summary(aes(group=grade), fun.y=mean, geom="line", colour="green")+
  ylab("KL div to patietn average of core")+
  xlab("Patientgroup")+
  ylim(c(0,2))+
  theme(panel.background = element_blank())+
  ggtitle('Cores assigned to patient group')

pdf('/home/jana/Desktop/R_dat/KL_stromalGroups.pdf')
p
dev.off()



kldiv_ordered = data.table(names(unlist(kldiv)))
kldiv_ordered$kldiv = as.vector(unlist(kldiv))
names(kldiv_ordered)[1] = 'core'
kldiv_ordered$core = unlist(lapply(strsplit(kldiv_ordered$core,'[.]'), function(x){paste(x[3:4],collapse = '.')}))
kldiv_ordered = merge(kldiv_ordered,asigned, by = 'core')
kldiv_ordered = merge(kldiv_ordered,unique(Sample_metadata[,c('core','patientcode')]), by = 'core')
kldiv_ordered[,patient_avg := mean(kldiv), by = 'patientcode']

kldiv_ordered$patientcode = factor(kldiv_ordered$patientcode, levels = as.vector(as.matrix(unique(kldiv_ordered[order(patient_avg),'patientcode']))))


p = ggplot(kldiv_ordered,aes(x = patientcode,y = kldiv,color = factor(patient_pheno)))+
  geom_point(aes(size = 13))+
  scale_color_manual(values = mycols_patient[sort(unique(kldiv_ordered$patient_pheno))])+
  theme(axis.text.x = element_text(angle = 90))+
   scale_size_continuous(range = c(0, 13))

pdf('/home/jana/Desktop/R_dat/out_of_names.pdf',height = 10,width = 15)
p
dev.off()



#Cell type variability across cores of patient
tmp = merge(image_wide,unique(Sample_metadata[,c('core','patientcode')]),by = 'core')
tmp = melt.data.table(tmp,id.vars = c('core','patientcode'))
tmp[,stnd := std(value),by = c('patientcode','variable')]
tmp = unique(tmp[,c('patientcode','variable','stnd')])
tmp = tmp[stnd != 0,]
tmp$variable = factor(tmp$variable, levels = 14:27)

pdf('/home/jana/Desktop/R_dat/celltype_stds.pdf')
ggplot(tmp,aes(x = variable,y = stnd,fill = variable))+
  geom_boxplot()+
  scale_fill_manual(values = mycols_basel_meta[sort(as.numeric(levels(tmp$variable)))])
dev.off()


#Sad clean plot

asigned = merge(asigned,unique(Sample_metadata[,c('core','patientcode')]),by = 'core');
co = merge(asigned_patient,asigned,by = 'patientcode')
co$patient_pheno_patient = factor(co$patient_pheno_patient,levels = as.character(1:18))
co$patient_pheno = factor(co$patient_pheno,levels = as.character(1:18))
co[,nr := .N , by = c('patient_pheno_patient','patient_pheno')]
co[,perc := nr/.N , by = c('patient_pheno_patient')]
co[,perc_core := nr/.N, by = 'patient_pheno']

pdf('/home/jana/Desktop/R_dat/sad_new_plot.pdf',width = 13)
ggplot(co, aes(x = patient_pheno, y = patient_pheno_patient)) + 
  geom_point(aes(size =perc,
                 color = perc_core)) + 
  scale_x_discrete(drop=FALSE)+
  scale_y_discrete(drop=FALSE)+
  #scale_color_manual(values = mycols_patient[unique(co$patient_pheno_patient)])+
  scale_color_gradient(low="white", high="red",name = "Perc of cores assigned to x in patients assigned to y") +
  scale_size(range = c(1, 15),name = "Of patient assigned to y, perc of images assigned to x") +
  theme(axis.text.y=element_text(color = c(mycols_patient[as.numeric(levels(co$patient_pheno_patient))])))
dev.off()



#How many agree

#co[,different := length(unique(patient_pheno)),by = 'patientcode']
# co[,frac_disagree := different/ .N ,by = 'patientcode']
# co[,frac_agree := 1 - frac_disagree]
# fr = unique(co[,c('patientcode','frac_disagree')])
# fr$frac_disagree = factor(fr$frac_disagree)
# fr[,nr := .N ,by = 'frac_disagree']
# fr[,perc := nr/.N] 
# fr = unique(fr[,c('frac_disagree','perc')])

co[,agree := patient_pheno == patient_pheno_patient]
co[,nr_agree := sum(agree),by = 'patientcode']
co[,perc_agree := nr_agree/.N ,by = 'patientcode']
co[,perc_disagree := 1 - perc_agree]
fr = unique(co[,c('patientcode','perc_disagree')])
fr$perc_disagree = factor(fr$perc_disagree)
fr[,nr := .N ,by = 'perc_disagree']
fr[,perc := nr/.N]
fr = unique(fr[,c('perc_disagree','perc')])

bp<- ggplot(fr, aes(x="", y=perc, fill=factor(perc_disagree,levels = rev(levels(perc_disagree)))))+
geom_bar(width = 1, stat = "identity")+
  scale_fill_grey(end = 0,start = 0.8)+
  #scale_fill_manual("Clusters",values =  c(mycols_basel_meta[1:13],'black'))+
    theme(strip.background = element_blank(),
        panel.background=element_rect(fill='white', colour = 'black'),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        plot.background=element_blank(),
        legend.key = element_blank())

pdf('/home/jana/Desktop/R_dat/bar.pdf')
bp
dev.off()


```

