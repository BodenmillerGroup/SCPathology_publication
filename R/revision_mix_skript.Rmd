---
title: "R Notebook"
output: html_notebook
---

Distributions markers
```{r}
dat[, c_counts_scaled := ((c_counts - min(c_counts))/(max(c_counts) - min(c_counts))), by=channel]
dat[,arcsinh_transf := asinh(c_counts/0.5),by = 'channel']

  pdf('/home/jana/Desktop/R_dat/marker_distributions_channel_arcsinh_transf.pdf',width = 30,height = 150)
  print(ggplot(dat[channel %in% good_channels,], aes(x=c_counts)) +
      geom_density(aes(y=..scaled..)) +
      facet_wrap( ~ channel, ncol=1))
  dev.off()
```
  
lasso for metaclusters
```{r}


work_dat = subset(dat[cluster_pheno],channel %in% good_channels)
work_dat = dcast.data.table(work_dat,'id + cluster ~ channel',value.var = 'c_counts')

sub_dat = data.table()
for (i in unique(work_dat$cluster)){
 idx = work_dat$cluster == i
 s = sample(which(idx),(length(which(idx))/5))
 sub_dat = rbind(sub_dat,work_dat[s,])
  
}

#scale data
scaled = scale(sub_dat[,-c('id','cluster')])
sub_dat = cbind(sub_dat[,c('id','cluster')],scaled)
lassores = cv.glmnet(as.matrix(sub_dat[,-c('id','cluster')]), sub_dat$cluster,family="multinomial")
plot(lassores)
save(lassores, file = "/home/jana/Desktop/R_dat/model.RData")

# library(biglm)
# lassores = biglm::bigglm(formula,work_dat[,-c('id')],family="multinomial",parallel = TRUE)


lassores$lambda.1se
Coefficients <- coef(lassores, s = lassores$lambda.1se)
# Active.Index <- which(Coefficients != 0)
# Active.Coefficients <- Coefficients[Active.Index]
# names(wide_image[,-c('patient_pheno')])[Active.Index]

hm_dat_zuri = hm_dat
colnames(hm_dat_zuri)[!colnames(hm_dat_zuri) %in% names(sub_dat)] = "Nd145Di Twist"
names(sub_dat)[!names(sub_dat) %in% colnames(hm_dat_zuri)]



pred = predict.cv.glmnet(lassores, hm_dat_zuri,type = 'class',s = 'lambda.1se') #remove type class to see all probabilities,,s = 'lambda.min'

wide_image$predicted = pred
wide_image$core = cores
wide_image[,tot_patient_pheno := .N ,by = 'patient_pheno']
wide_image[,tot_predicted := .N ,by = 'predicted']
wide_image[,sensitivity := sum(predicted == patient_pheno)/tot_patient_pheno, by = 'patient_pheno']
wide_image[,specificity := sum(predicted == patient_pheno)/tot_predicted,by = 'predicted']

scores = unique(wide_image[patient_pheno == predicted,c('patient_pheno','predicted','sensitivity','specificity')])
scores[order(as.numeric(predicted)),]


```

Patient clustered (hierarchical clustering from above) stacked barplot, tumor samples only with meta cluster cell type densities and labels colored by Phenograph patient group
```{r}
#On rare occasions where there are more than one cores per patient take mean of densities to display for patients
cluster_dat_tumors$cluster = factor(cluster_dat_tumors$cluster, levels = cluster_order_basel_meta) #cluster_order_basel for small clusters
cluster_dat_tumors[, perc_cells_patient := ncells*100/sum(ncells), by=patientcode]
cluster_dat_tumors[, area_cells_patient := mean(cluster_by_area), by=c('patientcode','cluster')]
cluster_dat_tumors = cluster_dat_tumors[order(patientcode)]

#Grade colors (in case grade should be visualized as vertical bar)
patient_grade_orig = cluster_dat_tumors[,c('patientcode','grade')]
patient_grade = unique(patient_grade_orig)
patient_grade = patient_grade[!duplicated(patient_grade$patientcode),]
patient_grade_all = patient_grade[hc$order]
grade_order = patient_grade_all$grade

#Patient cluster colors (for colors of patient names)
patient_cluster_orig = cluster_dat_tumors[,c('patientcode','patient_pheno')]
patient_cluster = unique(patient_cluster_orig)
patient_cluster = patient_cluster[!duplicated(patient_cluster$patientcode),]
patient_cluster_all = patient_cluster[hc$order]
cluster_order = patient_cluster_all$patient_pheno

#Clinical type colors (for clinical type vertical bar)
patient_clinical_orig = cluster_dat_tumors[,c('patientcode','clinical_type')]
patient_clinical = unique(patient_clinical_orig)
patient_clinical = patient_clinical[!duplicated(patient_clinical$patientcode),]
patient_clinical_all = patient_clinical[hc$order]
patient_clinical_all$clinical_type = factor(patient_clinical_all$clinical_type)
patient_clinical_all$clinical_type[patient_clinical_all$clinical_type == ""] = NA
clinical_order = patient_clinical_all$clinical_type


#older patient clustering
old = a[match(patient_cluster_all$patientcode, a$patientcode)]
old$patient_pheno[is.na(old$patient_pheno)] = 5
old$patient_pheno = factor(old$patient_pheno)
old_order = old$patient_pheno

#Plot:

#Stacked bar plot with cell type density colors per patient and labels colored by SC patient group
cut = cluster_dat_tumors[,c('patientcode','cluster','area_cells_patient')]
cut = unique(cut)
p <- ggplot(cut, aes(x=patientcode, y=area_cells_patient, fill=as.factor(cluster))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values =  mycols_basel_meta[as.numeric(cluster_order_basel_meta)])+ #mycols_basel for small clusters
  scale_x_discrete(limits = patient_cluster_all$patientcode)+
  labs(fill = "Clusters")+
  coord_flip()+
  xlab("Patient")+
  ylab("Percentage of cluster cells in patient")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=mycols_patient[cluster_order]))+
  ggtitle('Patient composition')

#Clinical type bar (can be exchanged for grade)
p3 <- ggplot(patient_clinical_all, aes(x=1,y=c(1:length(patient_clinical_all$clinical_type))))+
      geom_tile(aes( fill=clinical_type))+
  scale_fill_manual(values = mycols_clinical)+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          line = element_blank(),
          legend.position="none")

#Clinical type bar (can be exchanged for grade)
p4 <- ggplot(old, aes(x=1,y=c(1:length(old$patient_pheno))))+
      geom_tile(aes( fill=patient_pheno))+
  scale_fill_manual(values = mycols_patient_old)+
    theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank(),
          line = element_blank(),
          legend.position="none")

library('ggdendro')
#Dendrogram of hierarchical clustering
p2 <- ggdendrogram(hc, rotate = TRUE,labels = TRUE, theme_dendro = TRUE, leaf_labels = FALSE)+
  theme(axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_blank(),
          axis.ticks.y=element_blank())

#Alignment is good in pdf version if size is kept the same
p5 <- ggdraw() +
     draw_plot(p2 + scale_y_reverse(), 0, 0.001, 0.47, 0.998) +
     draw_plot(p ,0.5, 0.0355, 0.5, 0.926)+
     draw_plot(p3,0.4,0,0.05,1)+
    draw_plot(p4,0.45,0,0.05,1)

pdf(file="/home/jana/Desktop/R_dat/test.pdf", width=30, height=50)
p5
dev.off()

```

#Patientgroup composition
```{r}
cur = merge(dat[cluster_pheno][,c('id','core','cluster')], Sample_metadata,by = 'core')
cur = merge(cur,meta_patient_clustering,by = 'patientcode')
cur = unique(cur[,c('id','patient_pheno','cluster')])
cur$patient_pheno[is.na(cur$patient_pheno)] = 18
cur = unique(cur[cluster %in% 14:27,])
cur[,count := .N ,by = c('patient_pheno','cluster')]
cur[,frac := count/sum(.N) ,by = c('patient_pheno')]
cur = unique(cur[,c('cluster','frac','patient_pheno')])

p <- ggplot(cur, aes(x=patient_pheno, y=frac, fill=as.factor(cluster))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  scale_fill_manual("Clusters",values =  mycols_basel_meta[as.numeric(cluster_order_basel_meta[14:27])])+ #mycols_basel for small clusters
  scale_x_discrete(limits = cur$patient_pheno)+
  labs(fill = "Clusters")+
  coord_flip()+
  xlab("Patient")+
  ylab("Percentage of cluster cells in patient")+
  theme(panel.background = element_blank(),
        axis.text.y = element_text(colour=mycols_patient[unique(cur$patient_pheno)]))+
  ggtitle('Patient composition')

pdf('/home/jana/Desktop/R_dat/patient_group_comp_k11.pdf')
p
dev.off()

```

pvclust for metaclusters
```{r}




library(pvclust)

spearman <- function(x, ...) {
    x <- as.matrix(x)
    res <- as.dist(1 - cor(x, method = "spearman", use = "everything"))
    res <- as.dist(res)
    attr(res, "method") <- "spearman"
    return(res)
}

result <- pvclust(t(hm_dat), 
                  method.dist=spearman, method.hclust="ward.D2", nboot=5000)

result$merge = co_r$merge
result$order = co_r$order

d = as.dendrogram(result)
plot(result)

plot(rotate(d,hr$labels[hr$order]))
plot(result)
pvrect(result, alpha=0.95)

pdf('/home/jana/Desktop/R_dat/pvclust.pdf',width = 20,height = 10)
result %>% as.dendrogram  %>%
   plot(main = "Cluster dendrogram with AU/BP values (%)\n reproduced")
result %>% text
result %>% pvrect2(alpha = 0.95,border = 4)
dev.off()

```

#Compare dondrograms of clustrering
```{r}
dend1 = as.dendrogram(hr)
dend2 = as.dendrogram(hr)
dl <- dendlist(dend1, dend2)
tanglegram(dl, sort = TRUE, common_subtrees_color_lines = FALSE, highlight_distinct_edges  = FALSE, highlight_branches_lwd = FALSE)







```

```{r}
# dat = dat[!str_detect(dat$core,'control'),]
# dat = dat[!str_detect(dat$core,'non-breast'),]
# 
# 
# #cluster_pheno$cluster <- factor(cluster_pheno$cluster, levels = cluster_order)
# cluster_pheno$cluster = cluster_pheno$cluster + 1000
# cluster_pheno$cluster <- factor(cluster_pheno$cluster)
# dat[,c_counts := bbRtools::censor_dat(mc_counts,0.99),by = channel]
# 
# set.seed(2)
# summary_dat = dat[cluster_pheno][ channel %in% good_channels ,list(
#   median_val = median(c_counts),
#   mean_val= mean(c_counts),
#   cell_cluster=.N),
#   by=.(channel,cluster)]
# 
# 
# hm_dat = dcast.data.table(data =summary_dat, formula = 'cluster ~ channel',
#                           value.var = 'mean_val') #'median_val' can be exchanged for 'mean_val'
# 
# 
# # Row names
# trownames = hm_dat$cluster
# 
# # Convert to a matrix
# hm_dat = as.matrix(hm_dat[,-1,with=F])
# row.names(hm_dat) = trownames

hm_dat_zuri = hm_dat

# Z-score data
hm_dat_zuri = scale(hm_dat_zuri)
# # # Censor z-score at 2
# hm_dat_zuri[hm_dat_zuri > 2] =2
# hm_dat_zuri[hm_dat_zuri < -2] =-2


hm_dat_basel = fread('/home/jana/Desktop/hm_dat_basel.csv',header = T)
rownames = hm_dat_basel$V1
hm_dat_basel = as.matrix(hm_dat_basel[,-1])
rownames(hm_dat_basel)= rownames

hm_dat_basel = scale(hm_dat_basel)
# # Censor z-score at 2
# hm_dat_basel[hm_dat_basel > 2] =2
# hm_dat_basel[hm_dat_basel < -2] =-2


colnames(hm_dat_zuri)[!colnames(hm_dat_zuri) %in% colnames(hm_dat_basel)] = "Nd145Di Twist"
colnames(hm_dat_basel)[!colnames(hm_dat_basel) %in% colnames(hm_dat_zuri)]
# hm_dat_basel = hm_dat_basel[,colnames(hm_dat_zuri)]
# hm_dat = rbind(hm_dat_zuri,hm_dat_basel)



# # Set color map
# cols = rev(brewer.pal(11,'Spectral'))
# cmap = colorRampPalette(cols)
# 
# # Hierarchical clustering on rows with Ward's linkage
# tdist = as.dist(1-cor(t(hm_dat), method="spearman"))
# hr <- hclust(tdist, method="ward.D")
# co_r <- order.optimal(tdist, hr$merge)
# hr$merge = co_r$merge
# hr$order = co_r$order
# 
# #Order rows in heatmap according to clustering
# order_heatmap_zscored = row.names(hm_dat)[hr$order]
# 
# # Hierarchical clustering on columns with Ward's linkage
# tdist = as.dist(1-cor((hm_dat), method="spearman"))
# hc <- hclust(tdist, method="ward.D")
# co_c <- order.optimal(tdist, hc$merge)
# hc$merge = co_c$merge
# hc$order = co_c$order
# 
# # # Z-score data
# # p_dat = scale(hm_dat)
# 
# p_dat = hm_dat
# 
# # Censor z-score at 2
# p_dat[p_dat > 2] =2
# p_dat[p_dat < -2] =-2
# 
# 
# pdf('/home/jana/Desktop/R_dat/zuri_basel_heatmap.pdf')
# 
# heatmap.2(p_dat,
#           scale ='none',
#           trace = "none",
#           col=cmap(75),
#           Rowv=as.dendrogram(hr),
#           Colv=as.dendrogram(hc),
#           density.info ='none',
#           cexRow=0.6,
#           cexCol=0.6,
#           margins=c(4,8),
#           xlab = 'Markers',
#           ylab ='Cluster',
#           main = 'PG_norm_slide')
# 
# 
# 
# 
# 
# dev.off()

#Randomizing markers to see what correlations with unassociated clusters
set.seed(4)
rand_sample = sample(1:ncol(hm_dat_basel),ncol(hm_dat_basel),replace = F)
sapply(rand_sample,function(x){which(rand_sample == x) == x})
test = hm_dat_basel[,rand_sample]
crosscor = 1-cor(t(test),t(hm_dat_zuri),method = 'pearson')
idx_min = apply(crosscor,2,function(x){which(x == min(x))})
dist_min = apply(crosscor,2,min)
which(dist_min < 0.47) #less than 10%


#Actual correlations
crosscor = 1-cor(t(hm_dat_basel),t(hm_dat_zuri),method = 'pearson')
idx_min = apply(crosscor,2,function(x){which(x == min(x))})
dist_min = apply(crosscor,2,min)
asigned = data.table(rownames(crosscor)[unlist(idx_min)])
colnames(asigned) = 'Basel'
asigned$zuri = colnames(crosscor)
asigned$dist = dist_min
asigned$zuri = as.numeric(asigned$zuri)
asigned = asigned[order(zuri),]



pdf('/home/jana/Desktop/R_dat/cluster_correlations.pdf')
ggplot(asigned, aes(x = rev))+
     geom_density()+
  xlim(0,1)
dev.off()


p_dat = hm_dat_zuri
p_dat[p_dat > 2] =2
p_dat[p_dat < -2] =-2
p_dat = p_dat[order(as.numeric(rownames(p_dat))),]

asigned = asigned[order(as.numeric(Basel)),]
#only for zurich version where one cluster was weak stain specific, subtract one from everything >36
p_dat = p_dat[as.character(rev(asigned[order(match(asigned$Basel[asigned$Basel %in% hr$labels[hr$order]],hr$labels[hr$order])),zuri])),]
p_dat = p_dat[,match(hc$labels[hc$order],colnames(p_dat))]

cols_corresp_basel = mycols_basel_meta[rev(as.numeric(asigned[order(match(asigned$Basel[asigned$Basel %in% hr$labels[hr$order]],hr$labels[hr$order])),Basel]))]

pdf('/home/jana/Desktop/R_dat/zuri_heatmap_color_and_ord_matched_Basel.pdf')
heatmap.2(p_dat,
          scale ='none',
          trace = "none",
          col=cmap(75), dendrogram = "none", Rowv = FALSE, Colv = FALSE,
          density.info ='none',
          cexRow=0.6,
          cexCol=0.6,
          margins=c(4,8),
          xlab = 'Markers',
          ylab ='Cluster',
          main = 'PG_norm_slide',
          colRow = cols_corresp_basel)
dev.off()


fwrite(asigned,'/home/jana/Desktop/R_dat/zurich_basel_celltype_assignments.csv',col.names = T)


```

```{r}
library('nbpMatching')
crosscor = distancematrix(1-cor(t(rbind(hm_dat_basel,hm_dat_zuri))))
nbpmatch <- nonbimatch(crosscor)
get.sets(nbpmatch)
get.sets(nbpmatch$matches)
# include the phantom match
get.sets(nbpmatch$matches, FALSE)



```

earth movers distance
```{r}
for (i in unique(dat[channel %in% good_channels,]$channel)){
  cdat <- dat[cluster_pheno][channel %in% good_channels,][channel == i,][,markermean:= mean(c_counts),by = 'cluster']
  cdat$cluster = factor(cdat$cluster,levels = hr$labels[hr$order])




```

#Assign zurich images to Basel patient groups (redone zurich clustering version, excluding weak stains after clustetring k40)
```{r}
basel_patients = fread('/home/jana/Desktop/R_dat/patient_wide_basel.csv',header = T)
zuri_images = fread('/home/jana/Desktop/R_dat/image_wide_zurich.csv',header = T)


test = names(zuri_images)
test[names(zuri_images) == 37] = 26 #exclude from analysis?
test[names(zuri_images) == 4] = 22
test[names(zuri_images) == 10] = 22
test[names(zuri_images) == 11] = 22
test[names(zuri_images) == 27] = 22
test[names(zuri_images) == 6] = 24 #exclude?
test[names(zuri_images) == 19] = 23
test[names(zuri_images) == 22] = 23
test[names(zuri_images) == 29] = 23
test[names(zuri_images) == 31] = 25
test[names(zuri_images) == 24] = 25
test[names(zuri_images) == 14] = 20
test[names(zuri_images) == 30] = 20
test[names(zuri_images) == 32] = 20
test[names(zuri_images) == 9] = 19
test[names(zuri_images) == 23] = 19
test[names(zuri_images) == 33] = 19 
test[names(zuri_images) == 34] = 19 
test[names(zuri_images) == 40] = 19 #exclude?
test[names(zuri_images) == 13] = 27
test[names(zuri_images) == 12] = 18
test[names(zuri_images) == 17] = 17
test[names(zuri_images) == 20] = 16 #exclude?
test[names(zuri_images) == 38] =16
test[names(zuri_images) == 26] = 15 #exclude?
test[names(zuri_images) == 35] = 15 
test[names(zuri_images) == 25] = 14 
test[names(zuri_images) == 8] = 21 #manual
test[names(zuri_images) == 41] = 10 #exclude?
test[names(zuri_images) == 3] = 8 #exclude?
test[names(zuri_images) == 39] = 8
test[names(zuri_images) == 7] = 7
test[names(zuri_images) == 2] = 11 #exclude?
test[names(zuri_images) == 21] = 11
test[names(zuri_images) == 28] = 13
test[names(zuri_images) == 18] = 2
test[names(zuri_images) == 5] = 1
test[names(zuri_images) == 1] = 3
test[names(zuri_images) == 16] = 4
test[names(zuri_images) == 15] = 16 #manual

names(zuri_images) = test



#Aggregate same columns
zuri_images_sum = data.table(t(rowsum(t(zuri_images[,-'core']), group = colnames(zuri_images[,-'core']), na.rm = T)))
zuri_images_sum$core = zuri_images$core

#Fill up missing with 0
basel_long = melt.data.table(basel_patients, id.vars = 'patientcode')
zuri_long = melt.data.table(zuri_images_sum, id.vars = 'core')
names(basel_long)[names(basel_long) == 'patientcode'] = 'core'
zuri_basel = rbind(zuri_long,basel_long)
zuri_basel = dcast.data.table(zuri_basel, formula = 'core ~ variable',value.var = 'value',fill = 0)

basel = zuri_basel[str_detect(zuri_basel$core,'UB_SX_'),]
zuri = zuri_basel[str_detect(zuri_basel$core,'ZTMA208_'),]

meta_patient_clustering = fread(file='/home/jana/Desktop/R_dat/patient_groups_tumors_meta.csv', header = TRUE)
names(basel)[names(basel) == 'core'] = 'patientcode'
basel = merge(basel,meta_patient_clustering, by = 'patientcode',all.x = T)
basel$patient_pheno[is.na(basel$patient_pheno)] = 18
group_means = lapply(unique(basel$patient_pheno),function(x){colMeans(basel[patient_pheno == x,-c('patientcode','patient_pheno')])})
group_means_t = data.table(matrix(unlist(group_means), ncol = length(group_means[[1]]), byrow = TRUE))
group_means_t$patient_pheno = unique(basel$patient_pheno)
names(group_means_t) = c(names(group_means[[1]]),'patient_pheno')

basel_mat = as.matrix(group_means_t[,-c('patient_pheno')])
zuri_mat = as.matrix(zuri[,-'core'])

rownames(zuri_mat) = zuri$core
rownames(basel_mat) = group_means_t$patient_pheno
basel_mat = basel_mat[order(as.numeric(rownames(basel_mat))), ] 

crosscor = cor(t(basel_mat),t(zuri_mat))
idx_min = apply(crosscor,2,function(x){which(x == max(x))})
dist_min = apply(crosscor,2,max)
asigned = data.table(names(unlist(idx_min)))
colnames(asigned) = 'zuri'
asigned$basel = idx_min

#names(asigned) = c('core','patient_pheno')


fwrite(asigned,'/home/jana/Desktop/R_dat/cores_asigned.csv',col.names = T)


```

#Assign zurich patients to Basel patient groups 
```{r}
basel_patients = fread('/home/jana/Desktop/R_dat/patient_wide_basel.csv',header = T)
zuri_images = fread('/home/jana/Desktop/R_dat/patient_wide_zurich.csv',header = T)


#Fill up missing with 0
basel_long = melt.data.table(basel_patients, id.vars = 'patientcode')
zuri_long = melt.data.table(zuri_images, id.vars = 'patientcode')
zuri_basel = rbind(zuri_long,basel_long)
zuri_basel = dcast.data.table(zuri_basel, formula = 'patientcode ~ variable',value.var = 'value',fill = 0)

basel = zuri_basel[str_detect(zuri_basel$patientcode,'UB_SX_'),]
zuri = zuri_basel[!str_detect(zuri_basel$patientcode,'UB_SX_'),]

meta_patient_clustering = fread(file='/home/jana/Desktop/R_dat/patient_groups_tumors_meta.csv', header = TRUE)
basel = merge(basel,meta_patient_clustering, by = 'patientcode',all.x = T)
basel$patient_pheno[is.na(basel$patient_pheno)] = 18
group_means = lapply(unique(basel$patient_pheno),function(x){colMeans(basel[patient_pheno == x,-c('patientcode','patient_pheno')])})
group_means_t = data.table(matrix(unlist(group_means), ncol = length(group_means[[1]]), byrow = TRUE))
group_means_t$patient_pheno = unique(basel$patient_pheno)
names(group_means_t) = c(names(group_means[[1]]),'patient_pheno')

basel_mat = as.matrix(group_means_t[,-c('patient_pheno')])
zuri_mat = as.matrix(zuri[,-'patientcode'])

rownames(zuri_mat) = zuri$patientcode
rownames(basel_mat) = group_means_t$patient_pheno
basel_mat = basel_mat[order(as.numeric(rownames(basel_mat))), ] 

crosscor = cor(t(basel_mat),t(zuri_mat))
idx_min = apply(crosscor,2,function(x){which(x == max(x))})
dist_min = apply(crosscor,2,max)
asigned = data.table(names(unlist(idx_min)))
colnames(asigned) = 'zuri'
asigned$basel = idx_min

#names(asigned) = c('core','patient_pheno')


fwrite(asigned,'/home/jana/Desktop/R_dat/patient_asigned.csv',col.names = T)


```


#Tissue areas
```{r}
######## Load IHC information including AREA ########
filepath = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions'
EcadherinTissue <- fread(paste(filepath,"/QuPATH/ZT208_37_Ecadherin_Annotations.txt",sep=""),header = T)
HER2Tissue <- fread(paste(filepath,"/QuPATH/ZT208_39_HER2_Annotations.txt",sep=""),header = T)
ERTissue <- fread(paste(filepath,"/QuPATH/ZT208_7_ER_Annotations.txt",sep=""),header = T)
PRTissue <- fread(paste(filepath,"/QuPATH/ZT208_8_PR_Annotations.txt",sep=""),header = T)
KI67Tissue <- fread(paste(filepath,"/QuPATH/ZT208_6_KI67_Annotations.txt",sep=""),header = T)


# Format IHC quant data
names(EcadherinTissue)[1] <-paste("IHC_location")
names(EcadherinTissue)[6] <-paste("meanDAB_Ecadherin")
names(EcadherinTissue)[11] <-paste("Area_Ecadherin")
EcadherinTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',EcadherinTissue$IHC_location)
IHC <- subset(EcadherinTissue, , c('IHC_location','meanDAB_Ecadherin', 'Area_Ecadherin'))

names(HER2Tissue)[1] <-paste("IHC_location")
names(HER2Tissue)[6] <-paste("meanDAB_HER2")
names(HER2Tissue)[11] <-paste("Area_HER2")
HER2Tissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',HER2Tissue$IHC_location)
HER2Tissue <- subset(HER2Tissue, , c('IHC_location','meanDAB_HER2', 'Area_HER2'))
IHC = merge(IHC, HER2Tissue, by='IHC_location', all.x = TRUE)

names(ERTissue)[1] <-paste("IHC_location")
names(ERTissue)[6] <-paste("meanDAB_ER")
names(ERTissue)[26] <-paste("Area_ER")
ERTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',ERTissue$IHC_location)
ERTissue <- subset(ERTissue, , c('IHC_location','meanDAB_ER', 'Area_ER'))
IHC = merge(IHC, ERTissue, by='IHC_location', all.x = TRUE)

names(PRTissue)[1] <-paste("IHC_location")
names(PRTissue)[6] <-paste("meanDAB_PR")
names(PRTissue)[26] <-paste("Area_PR")
PRTissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',PRTissue$IHC_location)
PRTissue <- subset(PRTissue, , c('IHC_location','meanDAB_PR', 'Area_PR'))
IHC = merge(IHC, PRTissue, by='IHC_location', all.x = TRUE)

names(KI67Tissue)[1] <-paste("IHC_location")
names(KI67Tissue)[6] <-paste("meanDAB_KI67")
names(KI67Tissue)[11] <-paste("Area_KI67")
KI67Tissue[,'IHC_location']<- gsub(' - PathAnnotationObject', '',KI67Tissue$IHC_location)
KI67Tissue <- subset(KI67Tissue, , c('IHC_location','meanDAB_KI67', 'Area_KI67'))
IHC = merge(IHC, KI67Tissue, by='IHC_location', all.x = TRUE)
names(IHC)[names(IHC) == 'IHC_location'] = 'Name'

```
#SC IHC quant
```{r}
#Read in Zurich metadata with pos counts
fn_meta_zuri = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/Zuri_meta_IHCcounts.csv'
Sample_metadat_zuri <- read.csv(fn_meta_zuri,header = T)
Sample_metadat_zuri = data.table(Sample_metadat_zuri)
Sample_metadat_zuri = unique(Sample_metadat_zuri[,-'molecular.subtype'])
names(Sample_metadat_zuri)[names(Sample_metadat_zuri) == 'SP.Number'] = 'SP_NUMBER'
map = fread('/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_map.csv',header = T)
Sample_metadat_zuri = merge(Sample_metadat_zuri,map[,c('PATIENT_CODE','SP_NUMBER')],by = 'SP_NUMBER')
names(Sample_metadat_zuri)[names(Sample_metadat_zuri) == 'PATIENT_CODE'] = 'patientcode'
filepath = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/'

#Read in SC quant
Ki67pos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ki-67_Pos.txt",sep=""),header = T)
Ki67pos[,marker := 'Ki67pos']
Ki67pos[,all := 'Ki67']
Ki67pos = Ki67pos[,c('Name','marker','all')]

Ki67neg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ki-67_Neg.txt",sep=""),header = T)
Ki67neg[,marker := 'Ki67neg']
Ki67neg[,all := 'Ki67']
Ki67neg = Ki67neg[,c('Name','marker','all')]

PRpos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_PR_Pos.txt",sep=""),header = T)
PRpos[,marker := 'PRpos']
PRpos[,all := 'PR']
PRpos = PRpos[,c('Name','marker','all')]

PRneg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_PR_Neg.txt",sep=""),header = T)
PRneg[,marker := 'PRneg']
PRneg[,all := 'PR']
PRneg = PRneg[,c('Name','marker','all')]

ERpos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Pos.txt",sep=""),header = T)
ERpos[,marker := 'ERpos']
ERpos[,all := 'ER']
ERpos = ERpos[,c('Name','marker','all')]

ERneg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Neg.txt",sep=""),header = T)
ERneg[,marker := 'ERneg']
ERneg[,all := 'ER']
ERneg = ERneg[,c('Name','marker','all')]


#into one table
IHCSC = rbind(Ki67pos,Ki67neg,PRpos,PRneg,ERpos,ERneg)
IHCSC[,'Name']<- gsub(' - PathCellObject', '',IHCSC$Name)
IHCSC[,IHC_count := .N ,by = c('Name','marker')]
IHCSC[,tot_cells := .N, by = c('Name','all')]
IHCSC[,frac := IHC_count/tot_cells]
IHCSC = unique(IHCSC)

#Mapping info
fn_core = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_core.csv'
punch <- fread(fn_core,header = T)
punch = punch[,c('IHC location','IMC location')]
punch[,'IHC location']<- gsub(' ', '',punch$`IHC location`)

#Kick out controls
IHCSC= IHCSC[!Name %in% unique(IHCSC$Name[!IHCSC$Name %in% punch$`IHC location`]),]
punch= punch[!`IHC location` %in% unique(punch$`IHC location`[!punch$`IHC location` %in% IHCSC$Name]),]

#IHC data
IHCSC$IMCname = mapvalues(IHCSC$Name, unique(IHCSC$Name), punch[match(unique(IHCSC$Name),punch$`IHC location`),`IMC location`], warn_missing = TRUE)

##Cluster level
# #IMC data
# IMC_d = unique(cluster_dat[,c('core','cluster','ncells')])
# IMC_d$IMCname = unlist(lapply(strsplit(IMC_d$core,'_'),function(x){x[length(x)]}))
# 
# cur = IMC_d[cluster %in% 16:17,]
# cur[,tot_count := sum(ncells),by = 'core']
# cur = unique(cur[,c('core','IMCname','tot_count')])



#Ki67
wide = dcast.data.table(dat,formula = 'core + id ~ channel', value.var = 'c_counts')

pdf('/home/jana/Desktop/R_dat/test.pdf',width = 30, height = 30)
ggplot(wide, aes(x=`1441101Er168Di Ki67`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
dev.off()

ggplot(wide, aes(x=`1441101Er168Di Ki67`))+
  geom_density()+
  xlim(c(0,2))

#threshold = quantile(wide$`1441101Er168Di Ki67`, probs = 0.95,na.rm = T)

wide[,IMC_pos_count := length(which(`1441101Er168Di Ki67` > 0.5 )),by = 'core'] #/.N   for fraction
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

#comb = merge(sub,merge(unique(IHCSC[marker == 'Ki67pos',]),IHC[,c('Area_KI67','Name')],by = 'Name'), by = 'IMCname')
comb = merge(sub,unique(IHCSC[marker == 'Ki67pos',]), by = 'IMCname')
comb = merge(comb, Sample_metadata, by = 'core')
# comb[,IHC_density := IHC_count/Area_KI67]
# comb[,IMC_density := IMC_pos_count/area]

my.formula <- y ~ x

pdf('/home/jana/Desktop/R_dat/Ki67pos.pdf')
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()
dev.off()

# #CV across cores of patient for positive cells
# comb[,patient_meanIMC := mean(IMC_pos_count),by = 'patientcode']
# comb[,patient_meanIHC := mean(IHC_count),by = 'patientcode']
# comb[,patient_stdIMC := pracma::std(IMC_pos_count),by = 'patientcode']
# comb[,patient_stdIHC := pracma::std(IHC_count),by = 'patientcode']
# comb[,CV_IMC := patient_stdIMC/patient_meanIMC]
# comb[,CV_IHC := patient_stdIHC/patient_meanIHC]
# p = unique(comb[,c('patientcode','CV_IMC','CV_IHC')])
# 
# pdf('/home/jana/Desktop/R_dat/CV_Ki67pos.pdf')
# ggplot(p, aes(x=CV_IMC, y=CV_IHC ))+
#   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
#   geom_smooth(method = "lm")+
#   stat_poly_eq(formula = my.formula, 
#                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                 parse = TRUE) +
#   ggtitle('Ki67')+
#   theme_bw()
# dev.off()




#ER
pdf('/home/jana/Desktop/R_dat/test.pdf',width = 30, height = 30)
ggplot(wide, aes(x=`112475Gd156Di Estroge`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
dev.off()

ggplot(wide, aes(x=`112475Gd156Di Estroge`))+
  geom_density()+
  xlim(c(0,2))

wide[,IMC_pos_count := length(which(`112475Gd156Di Estroge` > 1 )),by = 'core'] #/.N   for fraction
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

comb = merge(sub,unique(IHCSC[marker == 'ERpos',]), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','patientcode')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('patientcode','Erperc')]), by = 'patientcode',all.x = T)

my.formula <- y ~ x

pdf('/home/jana/Desktop/R_dat/ERpos_1.pdf')
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=Erperc, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()
dev.off()

# #CV across cores of patient for positive cells
# comb[,patient_meanIMC := mean(IMC_pos_count),by = 'patientcode']
# comb[,patient_meanIHC := mean(IHC_count),by = 'patientcode']
# comb[,patient_stdIMC := pracma::std(IMC_pos_count),by = 'patientcode']
# comb[,patient_stdIHC := pracma::std(IHC_count),by = 'patientcode']
# comb[,CV_IMC := patient_stdIMC/patient_meanIMC]
# comb[,CV_IHC := patient_stdIHC/patient_meanIHC]
# p = unique(comb[,c('patientcode','CV_IMC','CV_IHC')])
# 
# pdf('/home/jana/Desktop/R_dat/CV_ERpos.pdf')
# ggplot(p, aes(x=CV_IMC, y=CV_IHC ))+
#   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
#   geom_smooth(method = "lm")+
#   stat_poly_eq(formula = my.formula, 
#                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                 parse = TRUE) +
#   ggtitle('ER')+
#   theme_bw()
# dev.off()




#PR
pdf('/home/jana/Desktop/R_dat/test.pdf',width = 30, height = 30)
ggplot(wide, aes(x=`312878Gd158Di Progest`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
dev.off()

wide[,IMC_pos_count := length(which(`312878Gd158Di Progest` > 1 )),by = 'core'] #/.N   for fraction # 1.5
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))

comb = merge(sub,unique(IHCSC[marker == 'PRpos',]), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','patientcode')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('patientcode','Prperc')]), by = 'patientcode',all.x = T)


my.formula <- y ~ x

pdf('/home/jana/Desktop/R_dat/PRpos.pdf')
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1, color=Prperc, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()
dev.off()


# #CV across cores of patient for positive cells
# comb[,patient_meanIMC := mean(IMC_pos_count),by = 'patientcode']
# comb[,patient_meanIHC := mean(IHC_count),by = 'patientcode']
# comb[,patient_stdIMC := pracma::std(IMC_pos_count),by = 'patientcode']
# comb[,patient_stdIHC := pracma::std(IHC_count),by = 'patientcode']
# comb[,CV_IMC := patient_stdIMC/patient_meanIMC]
# comb[,CV_IHC := patient_stdIHC/patient_meanIHC]
# p = unique(comb[,c('patientcode','CV_IMC','CV_IHC')])
# 
# pdf('/home/jana/Desktop/R_dat/CV_PRpos.pdf')
# ggplot(p, aes(x=CV_IMC, y=CV_IHC ))+
#   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
#   geom_smooth(method = "lm")+
#   stat_poly_eq(formula = my.formula, 
#                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                 parse = TRUE) +
#   ggtitle('PR')+
#   theme_bw()
# dev.off()



#Ecadh
Ecadh <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ecadherin.txt",sep=""),header = T)
Ecadh[,marker := 'Ecadh']
Ecadh = Ecadh[,c('Name','marker','Cell: DAB OD mean')]

ggplot(Ecadh, aes(x=`Cell: DAB OD mean`)) + 
    geom_density(alpha=.2, fill="#FF6666")

Ecadh[,IHC_count := length(which(`Cell: DAB OD mean` > 0.25 )),by = 'Name'] #/.N   for fraction
Ecadh[,'Name']<- gsub(' - PathCellObject', '',Ecadh$Name)
Ecadh = unique(Ecadh[,c('Name','IHC_count')])

#Mapping info
fn_core = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_core.csv'
punch <- fread(fn_core,header = T)
punch = punch[,c('IHC location','IMC location')]
punch[,'IHC location']<- gsub(' ', '',punch$`IHC location`)

#Kick out controls
Ecadh= Ecadh[!Name %in% unique(Ecadh$Name[!Ecadh$Name %in% punch$`IHC location`]),]
punch= punch[!`IHC location` %in% unique(punch$`IHC location`[!punch$`IHC location` %in% Ecadh$Name]),]

#IHC data
Ecadh$IMCname = mapvalues(Ecadh$Name, unique(Ecadh$Name), punch[match(unique(Ecadh$Name),punch$`IHC location`),`IMC location`], warn_missing = TRUE)

#IMC data
pdf('/home/jana/Desktop/R_dat/test.pdf',width = 30, height = 30)
ggplot(wide, aes(x=`1031747Er167Di ECadhe`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
dev.off()

ggplot(wide, aes(x=`1031747Er167Di ECadhe`))+
  geom_density()

wide[,IMC_pos_count := length(which(`1031747Er167Di ECadhe` > 3 )),by = 'core'] #/.N   for fraction #2.5
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))


comb = merge(sub,unique(Ecadh), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','patientcode')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('patientcode','Ecadh')]), by = 'patientcode',all.x = T)

my.formula <- y ~ x

pdf('/home/jana/Desktop/R_dat/Ecadhpos.pdf')
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=Ecadh, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()
dev.off()

# #CV across cores of patient for positive cells
# comb[,patient_meanIMC := mean(IMC_pos_count),by = 'patientcode']
# comb[,patient_meanIHC := mean(IHC_count),by = 'patientcode']
# comb[,patient_stdIMC := pracma::std(IMC_pos_count),by = 'patientcode']
# comb[,patient_stdIHC := pracma::std(IHC_count),by = 'patientcode']
# comb[,CV_IMC := patient_stdIMC/patient_meanIMC]
# comb[,CV_IHC := patient_stdIHC/patient_meanIHC]
# p = unique(comb[,c('patientcode','CV_IMC','CV_IHC')])
# 
# 
# pdf('/home/jana/Desktop/R_dat/CV_Ecadh.pdf')
# ggplot(p, aes(x=CV_IMC, y=CV_IHC ))+
#   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
#   geom_smooth(method = "lm")+
#   stat_poly_eq(formula = my.formula, 
#                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                 parse = TRUE) +
#   ggtitle('Ecadh')+
#   theme_bw()
# dev.off()



#HER2
HER2 <- fread(paste(filepath,"/QuPATH/ZT208_39 Detections.txt",sep=""),header = T)
HER2[,marker := 'HER2']
HER2 = HER2[,c('Name','marker','Cell: DAB OD mean')]

ggplot(HER2, aes(x=`Cell: DAB OD mean`)) + 
    geom_density(alpha=.2, fill="#FF6666")

HER2[,IHC_count := length(which(`Cell: DAB OD mean` > 0.5 )),by = 'Name'] #/.N   for fraction
HER2[,'Name']<- gsub(' - PathCellObject', '',HER2$Name)
HER2 = unique(HER2[,c('Name','IHC_count')])

#Mapping info
fn_core = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_core.csv' 
punch <- fread(fn_core,header = T)
punch = punch[,c('IHC location','IMC location')]
punch[,'IHC location']<- gsub(' ', '',punch$`IHC location`)

#Kick out controls
HER2= HER2[!Name %in% unique(HER2$Name[!HER2$Name %in% punch$`IHC location`]),]
punch= punch[!`IHC location` %in% unique(punch$`IHC location`[!punch$`IHC location` %in% HER2$Name]),]

#IHC data
HER2$IMCname = mapvalues(HER2$Name, unique(HER2$Name), punch[match(unique(HER2$Name),punch$`IHC location`),`IMC location`], warn_missing = TRUE)

#IMC data
pdf('/home/jana/Desktop/R_dat/test.pdf',width = 30, height = 30)
ggplot(wide, aes(x=`201487Eu151Di cerbB`, y=`234832Lu175Di panCyto` ))+
  geom_point(aes(alpha=1/10, size=0.01))+
  geom_density2d(colour = "red")
dev.off()

ggplot(wide, aes(x=`201487Eu151Di cerbB`))+
  geom_density()

wide[,IMC_pos_count := length(which(`201487Eu151Di cerbB` > 3 )),by = 'core'] #/.N   for fraction
sub = unique(wide[,c('core','IMC_pos_count')])
sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]}))


comb = merge(sub,unique(HER2), by = 'IMCname')
comb = merge(comb,Sample_metadata[,c('core','patientcode')], by = 'core')
comb = merge(comb,na.omit(Sample_metadat_zuri[,c('patientcode','HER2')]), by = 'patientcode',all.x = T)

my.formula <- y ~ x

pdf('/home/jana/Desktop/R_dat/HER2pos.pdf')
ggplot(comb, aes(x=IMC_pos_count, y=IHC_count ))+
  geom_point(aes(alpha=1,color=HER2, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  scale_color_viridis(option="viridis")+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()
dev.off()


# #CV across cores of patient for positive cells
# comb[,patient_meanIMC := mean(IMC_pos_count),by = 'patientcode']
# comb[,patient_meanIHC := mean(IHC_count),by = 'patientcode']
# comb[,patient_stdIMC := pracma::std(IMC_pos_count),by = 'patientcode']
# comb[,patient_stdIHC := pracma::std(IHC_count),by = 'patientcode']
# comb[,CV_IMC := patient_stdIMC/patient_meanIMC]
# comb[,CV_IHC := patient_stdIHC/patient_meanIHC]
# p = unique(comb[,c('patientcode','CV_IMC','CV_IHC')])
# 
# 
# pdf('/home/jana/Desktop/R_dat/CV_HER2.pdf')
# ggplot(p, aes(x=CV_IMC, y=CV_IHC ))+
#   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
#   geom_smooth(method = "lm")+
#   stat_poly_eq(formula = my.formula, 
#                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
#                 parse = TRUE) +
#   ggtitle('HER2')+
#   theme_bw()
# dev.off()



```

<!-- #CV across cores of patient within positive cells -->
<!-- ```{r} -->
<!-- #IMC -->
<!-- imc_pos = wide[`1441101Er168Di Ki67` > 0.5,]  -->
<!-- sub = unique(imc_pos[,c('core','id','1441101Er168Di Ki67')]) -->
<!-- sub[,mean_posIMC := mean(`1441101Er168Di Ki67`),by = 'core'] -->
<!-- sub = merge(sub, unique(Sample_metadata[,c('core','patientcode')]), by = 'core') -->
<!-- sub = sub[,c('mean_posIMC','patientcode','core')] -->
<!-- sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]})) -->

<!-- #KI67 -->
<!-- #IHC -->
<!-- Ki67pos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_Ki-67_Pos.txt",sep=""),header = T) -->
<!-- Ki67pos = Ki67pos[,c('Name','Cell: DAB OD mean')] -->
<!-- Ki67pos[,'Name']<- gsub(' - PathCellObject', '',Ki67pos$Name) -->
<!-- Ki67pos[,mean_posIHC := mean(`Cell: DAB OD mean`),by = 'Name'] -->


<!-- #Mapping info -->
<!-- fn_core = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_core.csv' -->
<!-- punch <- fread(fn_core,header = T) -->
<!-- punch = punch[,c('IHC location','IMC location')] -->
<!-- punch[,'IHC location']<- gsub(' ', '',punch$`IHC location`) -->

<!-- #Kick out controls -->
<!-- Ki67pos= Ki67pos[!Name %in% unique(Ki67pos$Name[!Ki67pos$Name %in% punch$`IHC location`]),] -->
<!-- punch= punch[!`IHC location` %in% unique(punch$`IHC location`[!punch$`IHC location` %in% Ki67pos$Name]),] -->

<!-- #IHC data -->
<!-- Ki67pos$IMCname = mapvalues(Ki67pos$Name, unique(Ki67pos$Name), punch[match(unique(Ki67pos$Name),punch$`IHC location`),`IMC location`], warn_missing = TRUE) -->
<!-- Ki67pos = unique(Ki67pos[,c('IMCname','mean_posIHC')]) -->

<!-- #Combine -->
<!-- comb = merge(sub,Ki67pos, by = 'IMCname') -->


<!-- comb[,mean_patientIMC := mean(mean_posIMC),by = 'patientcode'] -->
<!-- comb[,mean_patientIHC := mean(mean_posIHC),by = 'patientcode'] -->
<!-- comb[,std_patientIMC := pracma::std(mean_posIMC),by = 'patientcode'] -->
<!-- comb[,std_patientIHC := pracma::std(mean_posIHC),by = 'patientcode'] -->
<!-- comb[,cv_patientIMC := std_patientIMC/mean_patientIMC] -->
<!-- comb[,cv_patientIHC := std_patientIHC/mean_patientIHC] -->

<!-- comb = unique(comb[,c('patientcode','cv_patientIMC','cv_patientIHC')]) -->

<!-- ggplot(comb, aes(x=cv_patientIMC, y=cv_patientIHC ))+ -->
<!--   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE), -->
<!--   geom_smooth(method = "lm")+ -->
<!--   stat_poly_eq(formula = my.formula,  -->
<!--                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),  -->
<!--                 parse = TRUE) + -->
<!--   theme_bw() -->




<!-- #ER -->
<!-- #IMC -->
<!-- imc_pos = wide[`112475Gd156Di Estroge` > 0,]  -->
<!-- sub = unique(imc_pos[,c('core','id','112475Gd156Di Estroge')]) -->
<!-- sub[,mean_posIMC := mean(`112475Gd156Di Estroge`),by = 'core'] -->
<!-- sub = merge(sub, unique(Sample_metadata[,c('core','patientcode')]), by = 'core') -->
<!-- sub = sub[,c('mean_posIMC','patientcode','core')] -->
<!-- sub$IMCname = unlist(lapply(strsplit(sub$core,'_'),function(x){x[length(x)]})) -->


<!-- ERpos <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Pos.txt",sep=""),header = T) -->
<!-- ERpos = ERpos[,c('Name','Cell: DAB OD mean')] -->
<!-- ERpos[,'Name']<- gsub(' - PathCellObject', '',ERpos$Name) -->
<!-- #ERpos[,mean_posIHC := mean(`Cell: DAB OD mean`),by = 'Name'] -->

<!-- ERneg <- fread(paste(filepath,"/QuPATH/TMACoreSingleCell_ER_Neg.txt",sep=""),header = T) -->
<!-- ERneg = ERneg[,c('Name','Cell: DAB OD mean')] -->
<!-- ERneg[,'Name']<- gsub(' - PathCellObject', '',ERneg$Name) -->

<!-- ERboth = rbind(ERpos,ERneg) -->
<!-- ERboth[,mean_posIHC := mean(`Cell: DAB OD mean`),by = 'Name'] -->


<!-- #Mapping info -->
<!-- fn_core = '/home/ubuntu/tmp/server_homes/janaf/Data/2019/Revisions/TMA208_core.csv' -->
<!-- punch <- fread(fn_core,header = T) -->
<!-- punch = punch[,c('IHC location','IMC location')] -->
<!-- punch[,'IHC location']<- gsub(' ', '',punch$`IHC location`) -->

<!-- #Kick out controls -->
<!-- ERboth= ERboth[!Name %in% unique(ERboth$Name[!ERboth$Name %in% punch$`IHC location`]),] -->
<!-- punch= punch[!`IHC location` %in% unique(punch$`IHC location`[!punch$`IHC location` %in% ERboth$Name]),] -->

<!-- #IHC data -->
<!-- ERboth$IMCname = mapvalues(ERboth$Name, unique(ERboth$Name), punch[match(unique(ERboth$Name),punch$`IHC location`),`IMC location`], warn_missing = TRUE) -->
<!-- ERboth = unique(ERboth[,c('IMCname','mean_posIHC')]) -->

<!-- #Combine -->
<!-- comb = merge(sub,ERboth, by = 'IMCname') -->


<!-- comb[,mean_patientIMC := mean(mean_posIMC),by = 'patientcode'] -->
<!-- comb[,mean_patientIHC := mean(mean_posIHC),by = 'patientcode'] -->
<!-- comb[,std_patientIMC := pracma::std(mean_posIMC),by = 'patientcode'] -->
<!-- comb[,std_patientIHC := pracma::std(mean_posIHC),by = 'patientcode'] -->
<!-- comb[,cv_patientIMC := std_patientIMC/mean_patientIMC] -->
<!-- comb[,cv_patientIHC := std_patientIHC/mean_patientIHC] -->

<!-- comb = unique(comb[,c('patientcode','cv_patientIMC','cv_patientIHC')]) -->

<!-- ggplot(comb, aes(x=cv_patientIMC, y=cv_patientIHC ))+ -->
<!--   geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE), -->
<!--   geom_smooth(method = "lm")+ -->
<!--   stat_poly_eq(formula = my.formula,  -->
<!--                 aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")),  -->
<!--                 parse = TRUE) + -->
<!--   theme_bw() -->




<!-- ``` -->

#Pixel expansions
```{r}

pixel_dat = fread('/home/jana/Desktop/bb_volume_jana/Data/2018/Clinical_paper/Revisions/pixel6_data.csv')
names(pixel_dat)[1] = 'core'


test = unique(pixel_dat$core)

split_core = strsplit(pixel_dat$core,'_', fixed = TRUE)
pixel_dat$core = unlist(lapply(split_core, function(x){paste(x[c(1,2,8,9,10)],collapse =  "_")}))

#Replace the ones that don't need acquisition number again
short = unlist(lapply(strsplit(test,'_', fixed = TRUE),function(x){paste(x[c(1,2,8,9)],collapse =  "_")}))
duplicate_idx = duplicated(short) | duplicated(short, fromLast = TRUE)
in_cores_index = unlist(lapply(unique(pixel_dat$core)[duplicate_idx],function(x){which(pixel_dat$core %in% x)}))
pixel_dat$core[setdiff(1:length(pixel_dat$core),in_cores_index)] = unlist(lapply(strsplit(pixel_dat$core[setdiff(1:length(pixel_dat$core),in_cores_index)],'_', fixed = TRUE), function(x){paste(x[1:length(x)-1],collapse =  "_")}))

#Delete zeros
pixel_dat$core = unlist(lapply(pixel_dat$core,function(x){gsub("000","",x)}))


pixel_dat <- pixel_dat[, id := paste(.BY,collapse =  "_"), by=.(core,CellId)]

#Pixel expansion 2

pixel2 = pixel_dat
pixel2$nrNeighb = apply(pixel2[,3:(ncol(pixel2)-1)],1,function(x){sum(x != 0)})
pixel2 = pixel2[,c('id','nrNeighb')]




#test
dat_wide = dcast.data.table(dat,formula = 'id ~ channel',value.var = 'mc_counts')
test = merge(dat_wide[,c('id','Number_Neighbors')],pixel2,by = 'id')
plot_dat = test[sample(nrow(test), ceiling(nrow(test)/10), replace = FALSE, prob = NULL),]


my.formula <- y ~ x


p1 <- ggplot(plot_dat, aes(x=Number_Neighbors, y=nrNeighb ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  xlab('Pixelexpansion 4')+
  ylab('Pixelexpansion 4 recalculated')+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()



p2 <- ggplot(plot_dat, aes(x=Number_Neighbors, y=nrNeighb ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  xlab('Pixelexpansion 4')+
  ylab('Pixelexpansion 3')+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()


p3 <- ggplot(plot_dat, aes(x=Number_Neighbors, y=nrNeighb ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  xlab('Pixelexpansion 4')+
  ylab('Pixelexpansion 2')+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()

p4 <- ggplot(plot_dat, aes(x=Number_Neighbors, y=nrNeighb ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  xlab('Pixelexpansion 4')+
  ylab('Pixelexpansion 5')+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()

p5 <- ggplot(plot_dat, aes(x=Number_Neighbors, y=nrNeighb ))+
  geom_point(aes(alpha=1, size=1))+ #color=as.factor(GRADE),
  geom_smooth(method = "lm")+
  xlab('Pixelexpansion 4')+
  ylab('Pixelexpansion 6')+
  stat_poly_eq(formula = my.formula, 
                aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
                parse = TRUE) +
  theme_bw()



pdf('/home/jana/Desktop/R_dat/all_pixelexpansions_vs_4.pdf',width = 30, height = 20)
plot_grid(p1, p2,p3,p4,p5, ncol = 3)
dev.off()


test[,same := Number_Neighbors == nrNeighb]
pixel6_same = data.frame(sum(test$same))
names(pixel6_same) = 'tot_same'
pixel6_same$pixel = 6

test[,same := Number_Neighbors == nrNeighb]
pixel5_same = data.frame(sum(test$same))
names(pixel5_same) = 'tot_same'
pixel5_same$pixel = 5

test[,same := Number_Neighbors == nrNeighb]
pixel4_same = data.frame(sum(test$same))
names(pixel4_same) = 'tot_same'
pixel4_same$pixel = 4

test[,same := Number_Neighbors == nrNeighb]
pixel3_same = data.frame(sum(test$same))
names(pixel3_same) = 'tot_same'
pixel3_same$pixel = 3

test[,same := Number_Neighbors == nrNeighb]
pixel2_same = data.frame(sum(test$same))
names(pixel2_same) = 'tot_same'
pixel2_same$pixel = 2

all_same = rbind(pixel2_same,pixel3_same,pixel4_same,pixel5_same,pixel6_same)

p <- ggplot(all_same, aes(x=factor(pixel), y=tot_same)) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  xlab("Pixelexpansion")+
  ylab("Number of cells with same amount of neighbors as with PE 4")+
  theme(panel.background = element_blank())+
  ggtitle('Pixelexpansions')


pdf('/home/jana/Desktop/R_dat/number_cells_sameAmountNeighbors.pdf')
p
dev.off()

```

Boxplot cell types across patients
```{r}

p <- ggplot(cluster_dat, aes( as.factor(cluster),perc_cluster, fill = as.factor(cluster) ))+ #replace patient_pheno with clinical_type
     geom_violin()+
   scale_fill_manual(values = mycols_basel_meta[sort(as.numeric(unique(cluster_dat$cluster)))])

pdf(file=paste0("/home/jana/Desktop/R_dat/test.pdf"), width=10, height=90)
p
dev.off()

```

Scatterplots markers across patients
```{r}
cur_dat = dcast.data.table(dat, formula = 'id + core ~ channel', value.var = 'c_counts') 
cur_dat = cur_dat[cluster_pheno]
cur_dat = merge(cur_dat,Sample_metadata, by = "core")
cur_dat = cur_dat[cluster == 11,]

pdf('/home/jana/Desktop/R_dat/cluster11_patients.pdf',width = 60, height = 10)
ggplot()+
  geom_point(aes(x = as.matrix(cur_dat[,'1921755Sm149Di Vimenti']),y = as.matrix(cur_dat[,'3281668Nd142Di Fibrone']), color = as.matrix(cur_dat[,'patientcode'])))+
  discrete_scale( aesthetics = c("red","blue","green"),palette = rev(brewer.pal(11, 'Spectral')),scale_name = "discrete",name='Factors')+
  ggtitle('HRvsCK_inPatientgroup5')
dev.off()

pdf('/home/jana/Desktop/R_dat/cluster11_patients.pdf',width = 60, height = 10)
ggplot(cur_dat)+
  geom_boxplot(aes(y = `3281668Nd142Di Fibrone`, x = as.factor(patientcode)))+
  ggtitle('Fibronectin expr in cluster 11 across patients')
dev.off()

```


```{r}
dat = fread('/home/jana/Desktop/R_dat/communities.csv',header = T)

dat[,count := .N ,by = c('Community','Pheno')]
dat[,frac := count/sum(.N) ,by = c('Community')]
dat = unique(dat[,c('Community','frac','Pheno')])

p <- ggplot(dat, aes(x=factor(Community), y=frac, fill=as.factor(Pheno))) + 
  geom_bar(stat='identity',show.legend = TRUE)+
  #scale_x_discrete(limits = cur$patient_pheno)+
  labs(fill = "Clusters")+
  scale_fill_manual("Clusters",values =  mycols_basel_meta[sort(as.numeric(unique(dat$Pheno)))])+ #mycols_basel for small clusters
  coord_flip()+
  xlab("Community")+
  ylab("Percentage of cluster cells in community")+
  theme(panel.background = element_blank())+
  ggtitle('Community composition')

pdf('/home/jana/Desktop/R_dat/communities_celltypes.pdf')
p
dev.off()
```




